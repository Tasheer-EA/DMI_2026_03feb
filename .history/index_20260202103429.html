<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tasheer DMI – Admin Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- THEME VARIABLES (Matching Enterprise Edition) --- */
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-text: #94a3b8;
            --accent-color: #3b82f6;
            --bg-body: #f8fafc;
            --card-bg: #ffffff;
            --primary-blue: #004d9c;
            --sidebar-width: 260px;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        #app-wrapper {
            display: flex;
            height: 100%;
            opacity: 1;
            pointer-events: auto;
        }

        /* --- SIDEBAR (Matching Enterprise Edition) --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            overflow-y: auto;
            z-index: 100;
        }

        .brand-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .brand-logo img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .nav-link {
            color: var(--sidebar-text);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-weight: 500;
            text-decoration: none;
        }

        .nav-link:hover {
            background-color: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-link.active {
            background-color: var(--accent-color);
            color: white;
        }

        /* Division/Group Headers */
        .division-header {
            text-transform: none;
            font-weight: 700;
            color: white;
            font-size: 0.95rem;
            padding: 10px 16px 4px 16px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .division-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .division-toggle {
            transition: transform 0.2s;
            font-size: 0.8rem;
        }

        .division-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .division-toggle.expanded {
            transform: rotate(0deg);
        }

        .division-average {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
        }

        /* Sub-group styling */
        .sub-group-header {
            font-weight: 600;
            color: var(--sidebar-text);
            font-size: 0.9rem;
            padding: 8px 16px 4px 16px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .sub-group-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar .nav-link.sub-link {
            padding-left: 30px;
            font-size: 0.9rem;
        }

        .sidebar .nav-link span:first-of-type {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge-score {
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 40px;
            text-align: center;
        }

        .department-separator {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 10px 0;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.2s ease;
        }

        /* Top Bar */
        .admin-topbar {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 70px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 99;
            transition: left 0.2s ease;
        }

        /* --- CARDS & CHARTS --- */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            height: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kpi-card {
            border-radius: 16px;
            background: #ffffff;
            border: none;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
            padding: 18px 20px;
            height: 100%;
        }

        .kpi-label {
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        .kpi-value {
            font-size: 1.7rem;
            font-weight: 700;
            color: #111827;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- TABLE (Department List) --- */
        .custom-table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .table th {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            color: #475569;
        }

        .table-hover tbody tr:hover {
            background-color: #f1f5f9;
            cursor: pointer;
        }

        /* --- LOADING OVERLAY --- */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }

        .sand-clock-container {
            position: relative;
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
        }

        /* --- ORG STRUCTURE POPUP --- */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .popup-box {
            background: #ffffff;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            border-radius: 16px;
            padding: 20px 24px 28px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            animation: popupFadeIn 0.25s ease-out;
        }

        .popup-title {
            margin: 0 0 14px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #0f172a;
        }

        .close-popup {
            position: absolute;
            top: 8px;
            right: 16px;
            font-size: 28px;
            line-height: 1;
            cursor: pointer;
            color: #64748b;
        }

        .close-popup:hover {
            color: #0f172a;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 0px;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content, .admin-topbar {
                margin-left: 0;
                left: 0;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body onload="initAdminDashboard()">
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
        ">
        <div class="sand-clock-container">
            <div style="
                width: 0;
                height: 0;
                border-left: 30px solid transparent;
                border-right: 30px solid transparent;
                border-top: 30px solid var(--primary-blue);
                border-bottom: 30px solid transparent;
                border-radius: 50% / 0 0 50% 50%;
                position: absolute;
                top: 0;
                "></div>
            <div style="
                width: 0;
                height: 0;
                border-left: 30px solid transparent;
                border-right: 30px solid transparent;
                border-bottom: 30px solid var(--primary-blue);
                border-top: 30px solid transparent;
                border-radius: 50% / 50% 50% 0 0;
                position: absolute;
                bottom: 0;
                "></div>
            <div class="spinner-border text-primary" role="status" style="
                width: 40px;
                height: 40px;
                position: absolute;
                top: 10px;
                left: 10px;
                ">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="loadingText" class="fw-bold text-primary" style="font-size: 1.2rem;">
            Loading Dashboard...
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div id="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand-logo">
                <img src="assets/img/company-logo.png" alt="Tasheer">
                <span>DMI Enterprise</span>
            </div>
            
            <!-- Company Overall Link -->
            <a href="javascript:void(0)" id="companyOverallLink" 
               class="nav-link active d-flex justify-content-between align-items-center" 
               onclick="selectCompanyOverall()">
                <span class="d-flex align-items-center gap-2">
                    <i class="bi bi-building"></i>
                    <span>Company Overall</span>
                </span>
                <span class="badge-score" id="companyOverallBadge">–</span>
            </a>

            <div class="department-separator"></div>

            <!-- Navigation Menu -->
            <nav class="nav flex-column flex-grow-1" id="adminDeptList">
                <!-- Will be populated by JavaScript -->
            </nav>

            <!-- User Profile -->
            <div class="user-profile text-white small mt-auto pt-3">
                <div class="fw-bold" id="sidebar-username">Admin</div>
                <div class="opacity-50 mb-2" id="sidebar-role">System Administrator</div>
                <a href="javascript:void(0)" onclick="handleLogout()" class="text-danger small text-decoration-none">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <header class="admin-topbar">
                <div>
                    <div class="text-muted small">Admin Dashboard</div>
                    <h4 class="fw-semibold mb-0 text-primary" id="adminDeptTitle">Company Overall Dashboard</h4>
                </div>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <button id="openAssessmentBtn" class="btn btn-sm btn-outline-primary" type="button">
                        <i class="bi bi-box-arrow-up-right me-1"></i> Open Assessment
                    </button>
                    <a href="ceo_dashboard.html" class="btn btn-sm btn-primary">
                        <i class="bi bi-graph-up-arrow me-1"></i> Executive Dashboard
                    </a>
                    <button class="btn btn-sm btn-outline-danger" type="button" onclick="handleLogout()">
                        <i class="bi bi-power me-1"></i> Logout
                    </button>
                </div>
            </header>

            <!-- KPI Cards -->
            <div class="row g-3 mb-4 mt-4">
                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card text-center">
                        <div class="kpi-label">Overall Maturity</div>
                        <svg id="overallGauge" width="240" height="120" viewBox="0 0 240 120">
                            <path d="M20 110 A100 100 0 0 1 220 110"
                                  fill="none" stroke="#e5e7eb" stroke-width="20" />
                            <path id="overallGaugeArc"
                                  d="M20 110 A100 100 0 0 1 220 110"
                                  fill="none" stroke="#3b82f6" stroke-width="20"
                                  stroke-linecap="round"
                                  stroke-dasharray="314" stroke-dashoffset="314" />
                            <text id="overallGaugeText"
                                  x="120" y="85"
                                  text-anchor="middle"
                                  font-size="28" font-weight="700"
                                  fill="#111827">0%</text>
                        </svg>
                        <div class="kpi-sub">Percentage of max score</div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card text-center">
                        <div class="kpi-label">Maturity Band</div>
                        <svg id="batteryGauge" width="200" height="90">
                            <rect id="batteryFrame"
                                  x="10" y="20"
                                  width="160" height="60"
                                  rx="8"
                                  stroke="#9ca3af"
                                  stroke-width="4"
                                  fill="none"></rect>
                            <rect x="170" y="40" width="15" height="20" rx="3" fill="#9ca3af"></rect>
                            <g id="batteryBars"></g>
                            <text id="batteryRecharge"
                                  x="90" y="60"
                                  text-anchor="middle"
                                  font-size="22"
                                  fill="#b91c1c"
                                  style="display: none;">⚡</text>
                        </svg>
                        <div id="bandLabel" class="fw-bold mt-2">–</div>
                        <div id="bandDesc" class="kpi-sub"></div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card text-center">
                        <div class="kpi-label">Progress</div>
                        <div class="d-flex justify-content-center align-items-end" style="height: 120px;">
                            <svg id="ladderGauge" width="120" height="100"></svg>
                        </div>
                        <div class="kpi-sub mt-2" id="cupLabel">Answered / total questions</div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card text-center">
                        <div class="kpi-label">Company DMI</div>
                        <div class="position-relative d-inline-block mt-2" style="width: 120px; height: 120px;">
                            <svg id="dmiDoughnut" width="120" height="120" viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#e5e7eb" stroke-width="12" />
                                <circle id="dmiDoughnutFill" cx="60" cy="60" r="50" fill="none" stroke="#004d9c" stroke-width="12" 
                                        stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="314" />
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle text-center">
                                <div id="dmiDoughnutText" class="fw-bold text-dark" style="font-size: 1.5rem;">0%</div>
                                <div class="text-muted small" style="font-size: 0.65rem;">Overall</div>
                            </div>
                        </div>
                        <div class="kpi-sub mt-2">Average maturity across all departments</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4">
                <div class="col-12">
                    <div class="stat-card">
                        <h6 class="fw-bold mb-3" id="chartTitle">Overall Maturity Breakdown by Entity</h6>
                        <svg id="sectionChart" width="100%" height="400"></svg>
                    </div>
                </div>
            </div>

            <!-- Org Structure Link -->
            <div class="mt-4">
                <a href="javascript:void(0)" id="orgStructureLink"
                   class="nav-link d-inline-flex align-items-center gap-2 text-primary"
                   onclick="showOrgStructureView()">
                    <i class="bi bi-diagram-3"></i>
                    <span>Tasheer Org Structure Overview</span>
                </a>
            </div>
        </div>
    </div>

    <!-- ORG STRUCTURE POPUP -->
    <div id="orgStructureModal" class="popup-overlay">
        <div class="popup-box">
            <span class="close-popup" onclick="closeOrgStructureModal()">×</span>
            <h2 class="popup-title">DMI by Departments</h2>
            <div class="org-chart-container">
                <img src="assets/img/Org.png" alt="Tasheer Org Structure" class="org-chart-image">
                <!-- Percentage badges will be added here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data Structures
        const ADMIN_HIERARCHY = [
            {
                code: "product_bizdev",
                name: "Product & Business Development",
                isDivision: true,
                departments: [
                    { code: "business_dev", name: "Business Development", icon: "bi-briefcase" },
                    { code: "marketing", name: "Marketing & Communication", icon: "bi-megaphone" },
                    { code: "product_mgmt", name: "Product Management", icon: "bi-box-seam" },
                ]
            },
            {
                code: "digi_tech",
                name: "Digitization & Technology",
                isDivision: true,
                departments: [
                    {
                        code: "tech_strategy_group",
                        name: "Tech Strategy & EA Unit",
                        isSubGroup: true,
                        groupDepartments: [
                            { code: "tech_strategy", name: "Tech Strategy & EA", icon: "bi-layers" },
                            { code: "sap_ERP", name: "SAP ERP", icon: "bi-diagram-3-fill" },
                            { code: "tech_ITSM", name: "Tech & ITSM", icon: "bi-tools" },
                        ]
                    },
                    { code: "solution_delivery", name: "Solution Development & Delivery", icon: "bi-gear" },
                    { code: "it_operations", name: "Platforms & IT Solution Ops", icon: "bi-cpu" },
                    { code: "infra_ops", name: "Infrastructure & Operations", icon: "bi-hdd-stack" },
                    { code: "corporate_it", name: "Corporate IT", icon: "bi-laptop" },
                    { code: "data_analytics", name: "Data Analytics", icon: "bi-bar-chart-line" },
                ]
            },
            {
                code: "shared_services",
                name: "Shared Services",
                isDivision: true,
                departments: [
                    { code: "human_capital", name: "Human Capital Management", icon: "bi-people" },
                    { code: "procurement", name: "Procurement", icon: "bi-cart-check" },
                ]
            },
            { code: "branches_ops", name: "Branches Operations", icon: "bi-shop", isStandalone: true },
            { code: "finance", name: "Finance", icon: "bi-bank", isStandalone: true },
            { code: "pmo", name: "PMO", icon: "bi-diagram-3", isStandalone: true },
            { code: "internal_audit", name: "Internal Auditing", icon: "bi-clipboard-data", isStandalone: true },
            { code: "grc", name: "GRC", icon: "bi-shield-check", isStandalone: true },
            { code: "business_excellence", name: "Business Excellence", icon: "bi-stars", isStandalone: true },
            { code: "legal_affairs", name: "Legal & Regulatory", icon: "bi-journal-text", isStandalone: true },
            { code: "cybersecurity", name: "Cybersecurity", icon: "bi-shield-lock", isStandalone: true },
        ];

        let currentAdminDeptCode = null;
        let isCompanyOverallSelected = true;
        let currentUser = null;

        // Initialize Admin Dashboard
        function initAdminDashboard() {
            // Check if user is logged in
            const userSession = sessionStorage.getItem('tasheer_user_ent_v3');
            if (!userSession) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userSession);
            
            // Update user info in sidebar
            document.getElementById('sidebar-username').innerText = currentUser.username || 'Admin';
            document.getElementById('sidebar-role').innerText = currentUser.role === 'admin' ? 'System Administrator' : 'Department User';

            // Build sidebar navigation
            buildAdminSidebar();
            
            // Set default view to Company Overall
            selectCompanyOverall();
            
            // Hide loading screen
            hideLoadingScreen();
            
            // Add event listener for Open Assessment button
            document.getElementById('openAssessmentBtn').addEventListener('click', openAssessmentForCurrent);
        }

        function hideLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            }
        }

        function buildAdminSidebar() {
            const list = document.getElementById("adminDeptList");
            list.innerHTML = "";

            ADMIN_HIERARCHY.forEach(item => {
                if (item.isDivision) {
                    // Division header with toggle
                    const divHeader = document.createElement("div");
                    divHeader.className = "division-header";
                    divHeader.innerHTML = `
                        <span>${item.name}</span>
                        <i class="bi bi-chevron-down division-toggle expanded"></i>
                    `;
                    
                    // Division container for departments
                    const divContainer = document.createElement("div");
                    divContainer.id = `div-${item.code}`;
                    divContainer.style.paddingLeft = "10px";
                    
                    // Add departments to container
                    item.departments.forEach(dept => {
                        if (dept.isSubGroup) {
                            // Sub-group header
                            const subHeader = document.createElement("div");
                            subHeader.className = "sub-group-header";
                            subHeader.innerHTML = `
                                <span>${dept.name}</span>
                                <i class="bi bi-chevron-down division-toggle expanded" style="font-size: 0.8rem;"></i>
                            `;
                            divContainer.appendChild(subHeader);
                            
                            // Sub-group container
                            const subContainer = document.createElement("div");
                            subContainer.id = `sub-${dept.code}`;
                            subContainer.style.paddingLeft = "15px";
                            
                            // Add sub-departments
                            dept.groupDepartments.forEach(subDept => {
                                const link = createDepartmentLink(subDept, item.code);
                                subContainer.appendChild(link);
                            });
                            
                            divContainer.appendChild(subContainer);
                            
                            // Toggle sub-group
                            subHeader.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const icon = subHeader.querySelector('.division-toggle');
                                if (subContainer.style.display === 'none') {
                                    subContainer.style.display = 'block';
                                    icon.classList.remove('collapsed');
                                    icon.classList.add('expanded');
                                } else {
                                    subContainer.style.display = 'none';
                                    icon.classList.remove('expanded');
                                    icon.classList.add('collapsed');
                                }
                            });
                        } else {
                            const link = createDepartmentLink(dept, item.code);
                            divContainer.appendChild(link);
                        }
                    });
                    
                    list.appendChild(divHeader);
                    list.appendChild(divContainer);
                    
                    // Toggle division
                    divHeader.addEventListener('click', () => {
                        const icon = divHeader.querySelector('.division-toggle');
                        if (divContainer.style.display === 'none') {
                            divContainer.style.display = 'block';
                            icon.classList.remove('collapsed');
                            icon.classList.add('expanded');
                        } else {
                            divContainer.style.display = 'none';
                            icon.classList.remove('expanded');
                            icon.classList.add('collapsed');
                        }
                    });
                } else {
                    // Standalone department
                    const link = createDepartmentLink(item, null);
                    list.appendChild(link);
                }
            });
        }

        function createDepartmentLink(dept, parentCode) {
            const score = computeDepartmentAverage(dept.code);
            const link = document.createElement("a");
            link.href = "javascript:void(0)";
            link.className = "nav-link d-flex justify-content-between align-items-center";
            link.dataset.code = dept.code;
            link.dataset.parent = parentCode;
            link.innerHTML = `
                <span class="d-flex align-items-center gap-2">
                    <i class="bi ${dept.icon}"></i>
                    <span>${dept.name}</span>
                </span>
                <span class="badge-score">${score}</span>
            `;
            link.addEventListener("click", () => selectDepartment(dept.code));
            return link;
        }

        function computeDepartmentAverage(deptCode) {
            // This should be implemented based on your data structure
            // For now, return a placeholder
            const saved = localStorage.getItem(`tasheer_dmi_${deptCode}`);
            if (!saved) return "N/A";
            
            try {
                const data = JSON.parse(saved);
                if (data.overallScore) {
                    return `${data.overallScore}%`;
                }
            } catch (e) {
                console.error("Error parsing department data:", e);
            }
            
            return "N/A";
        }

        function selectCompanyOverall() {
            isCompanyOverallSelected = true;
            currentAdminDeptCode = null;
            
            // Update active states
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById('companyOverallLink').classList.add('active');
            document.getElementById('adminDeptTitle').textContent = "Company Overall Dashboard";
            
            // Calculate and update KPIs
            const overallScore = computeCompanyOverallDMI();
            updateKPIs(overallScore);
            renderCompanyEntityBreakdown();
            
            // Update company overall badge
            document.getElementById('companyOverallBadge').textContent = overallScore + "%";
        }

        function selectDepartment(deptCode) {
            isCompanyOverallSelected = false;
            currentAdminDeptCode = deptCode;
            
            // Update active states
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll(`.nav-link[data-code="${deptCode}"]`).forEach(link => link.classList.add('active'));
            document.getElementById('companyOverallLink').classList.remove('active');
            
            // Find department name
            let deptName = "";
            for (const item of ADMIN_HIERARCHY) {
                if (item.isDivision) {
                    for (const dept of item.departments) {
                        if (dept.code === deptCode) {
                            deptName = dept.name;
                            break;
                        }
                        if (dept.isSubGroup) {
                            for (const subDept of dept.groupDepartments) {
                                if (subDept.code === deptCode) {
                                    deptName = subDept.name;
                                    break;
                                }
                            }
                        }
                    }
                } else if (item.code === deptCode) {
                    deptName = item.name;
                }
                if (deptName) break;
            }
            
            document.getElementById('adminDeptTitle').textContent = `${deptName} Dashboard`;
            
            // Calculate and update KPIs for this department
            const deptScore = getDepartmentScore(deptCode);
            updateKPIs(deptScore);
            renderDepartmentBreakdown(deptCode);
        }

        function computeCompanyOverallDMI() {
            // Calculate average of all departments
            let total = 0;
            let count = 0;
            
            ADMIN_HIERARCHY.forEach(item => {
                if (item.isDivision) {
                    item.departments.forEach(dept => {
                        if (dept.isSubGroup) {
                            dept.groupDepartments.forEach(subDept => {
                                const score = getDepartmentScore(subDept.code);
                                if (score !== null) {
                                    total += score;
                                    count++;
                                }
                            });
                        } else {
                            const score = getDepartmentScore(dept.code);
                            if (score !== null) {
                                total += score;
                                count++;
                            }
                        }
                    });
                } else {
                    const score = getDepartmentScore(item.code);
                    if (score !== null) {
                        total += score;
                        count++;
                    }
                }
            });
            
            return count > 0 ? Math.round(total / count) : 0;
        }

        function getDepartmentScore(deptCode) {
            const saved = localStorage.getItem(`tasheer_dmi_${deptCode}`);
            if (!saved) return null;
            
            try {
                const data = JSON.parse(saved);
                return data.overallScore || null;
            } catch (e) {
                return null;
            }
        }

        function updateKPIs(score) {
            // Update overall gauge
            const arc = document.getElementById("overallGaugeArc");
            const txt = document.getElementById("overallGaugeText");
            const max = 314;
            const offset = max - (max * (score / 100));
            if (arc) arc.style.strokeDashoffset = offset;
            if (txt) txt.textContent = score + "%";
            
            // Update doughnut chart
            const circle = document.getElementById("dmiDoughnutFill");
            const doughnutText = document.getElementById("dmiDoughnutText");
            if (circle) {
                const radius = 50;
                const circumference = 2 * Math.PI * radius;
                const offsetDoughnut = circumference - ((score / 100) * circumference);
                circle.style.strokeDasharray = `${circumference}`;
                circle.style.strokeDashoffset = offsetDoughnut;
                
                // Dynamic color
                if (score < 50) circle.setAttribute("stroke", "#ef4444");
                else if (score < 75) circle.setAttribute("stroke", "#f97316");
                else circle.setAttribute("stroke", "#004d9c");
            }
            if (doughnutText) doughnutText.textContent = score + "%";
            
            // Update maturity band
            updateMaturityBand(score);
        }

        function updateMaturityBand(score) {
            let bandName = "Unclassified";
            let bandLevel = 0;
            
            if (score >= 90) {
                bandName = "Optimized";
                bandLevel = 5;
            } else if (score >= 75) {
                bandName = "Advanced";
                bandLevel = 4;
            } else if (score >= 50) {
                bandName = "Managed";
                bandLevel = 3;
            } else if (score >= 25) {
                bandName = "Developing";
                bandLevel = 2;
            } else if (score > 0) {
                bandName = "Initial";
                bandLevel = 1;
            } else {
                bandName = "Non-Existent";
                bandLevel = 0;
            }
            
            document.getElementById("bandLabel").textContent = bandName;
            document.getElementById("bandDesc").textContent = getBandDescription(bandName);
            
            // Update battery bars
            updateBatteryBars(bandLevel);
        }

        function getBandDescription(bandName) {
            const descriptions = {
                "Non-Existent": "No formal processes in place",
                "Initial": "Ad-hoc, reactive processes",
                "Developing": "Basic processes being established",
                "Managed": "Standardized and documented processes",
                "Advanced": "Measured and optimized processes",
                "Optimized": "Continuous improvement and innovation"
            };
            return descriptions[bandName] || "";
        }

        function updateBatteryBars(level) {
            const barsContainer = document.getElementById("batteryBars");
            barsContainer.innerHTML = "";
            
            const colors = {
                0: "#ef4444",
                1: "#f97316",
                2: "#eab308",
                3: "#22c55e",
                4: "#3b82f6",
                5: "#0f172a"
            };
            
            const totalBars = 10;
            const filledBars = level * 2;
            
            for (let i = 0; i < totalBars; i++) {
                const bar = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                bar.setAttribute("x", 18 + i * 14);
                bar.setAttribute("y", 30);
                bar.setAttribute("width", 10);
                bar.setAttribute("height", 40);
                bar.setAttribute("rx", 3);
                bar.setAttribute("fill", i < filledBars && level > 0 ? colors[level] : "#e5e7eb");
                barsContainer.appendChild(bar);
            }
            
            // Update battery frame color
            const frame = document.getElementById("batteryFrame");
            const recharge = document.getElementById("batteryRecharge");
            if (level === 0) {
                frame.setAttribute("stroke", "#b91c1c");
                if (recharge) recharge.style.display = "block";
            } else {
                frame.setAttribute("stroke", "#9ca3af");
                if (recharge) recharge.style.display = "none";
            }
        }

        function renderCompanyEntityBreakdown() {
            const svg = document.getElementById("sectionChart");
            if (!svg) return;
            svg.innerHTML = "";
            
            const entities = [];
            
            // Collect all entities (divisions and standalone departments)
            ADMIN_HIERARCHY.forEach(item => {
                if (item.isDivision) {
                    entities.push({
                        name: item.name,
                        score: computeDivisionScore(item),
                        isDivision: true
                    });
                } else {
                    entities.push({
                        name: item.name,
                        score: getDepartmentScore(item.code) || 0,
                        isDivision: false
                    });
                }
            });
            
            // Sort by score
            entities.sort((a, b) => b.score - a.score);
            
            // Draw chart
            const width = svg.clientWidth || 800;
            const height = 400;
            const margin = { top: 20, right: 100, bottom: 30, left: 200 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            const barHeight = 30;
            const gap = 10;
            
            svg.setAttribute("width", width);
            svg.setAttribute("height", height);
            
            const ns = "http://www.w3.org/2000/svg";
            
            // Draw bars
            entities.forEach((entity, i) => {
                const y = margin.top + i * (barHeight + gap);
                const barWidth = (entity.score / 100) * chartWidth;
                
                // Background bar
                const bgRect = document.createElementNS(ns, "rect");
                bgRect.setAttribute("x", margin.left);
                bgRect.setAttribute("y", y);
                bgRect.setAttribute("width", chartWidth);
                bgRect.setAttribute("height", barHeight);
                bgRect.setAttribute("rx", 6);
                bgRect.setAttribute("fill", "#e5e7eb");
                svg.appendChild(bgRect);
                
                // Value bar
                const rect = document.createElementNS(ns, "rect");
                rect.setAttribute("x", margin.left);
                rect.setAttribute("y", y);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", barHeight);
                rect.setAttribute("rx", 6);
                rect.setAttribute("fill", entity.isDivision ? "#3b82f6" : "#004d9c");
                svg.appendChild(rect);
                
                // Entity name
                const label = document.createElementNS(ns, "text");
                label.setAttribute("x", margin.left - 10);
                label.setAttribute("y", y + barHeight / 2 + 5);
                label.setAttribute("text-anchor", "end");
                label.setAttribute("font-size", "12");
                label.setAttribute("font-weight", entity.isDivision ? "600" : "400");
                label.textContent = entity.name;
                svg.appendChild(label);
                
                // Score percentage
                const scoreText = document.createElementNS(ns, "text");
                scoreText.setAttribute("x", margin.left + barWidth + 5);
                scoreText.setAttribute("y", y + barHeight / 2 + 5);
                scoreText.setAttribute("text-anchor", "start");
                scoreText.setAttribute("font-size", "12");
                scoreText.setAttribute("font-weight", "600");
                scoreText.textContent = entity.score + "%";
                svg.appendChild(scoreText);
            });
            
            // Update chart title
            document.getElementById("chartTitle").textContent = "Overall Maturity Breakdown by Entity";
        }

        function computeDivisionScore(division) {
            let total = 0;
            let count = 0;
            
            division.departments.forEach(dept => {
                if (dept.isSubGroup) {
                    dept.groupDepartments.forEach(subDept => {
                        const score = getDepartmentScore(subDept.code);
                        if (score !== null) {
                            total += score;
                            count++;
                        }
                    });
                } else {
                    const score = getDepartmentScore(dept.code);
                    if (score !== null) {
                        total += score;
                        count++;
                    }
                }
            });
            
            return count > 0 ? Math.round(total / count) : 0;
        }

        function renderDepartmentBreakdown(deptCode) {
            // This would render detailed breakdown for a specific department
            const svg = document.getElementById("sectionChart");
            if (!svg) return;
            svg.innerHTML = "<text x='50%' y='50%' text-anchor='middle'>Department details would be shown here</text>";
            
            // Update chart title
            const dept = findDepartment(deptCode);
            if (dept) {
                document.getElementById("chartTitle").textContent = `${dept.name} Detailed Analysis`;
            }
        }

        function findDepartment(deptCode) {
            for (const item of ADMIN_HIERARCHY) {
                if (item.isDivision) {
                    for (const dept of item.departments) {
                        if (dept.code === deptCode) return dept;
                        if (dept.isSubGroup) {
                            for (const subDept of dept.groupDepartments) {
                                if (subDept.code === deptCode) return subDept;
                            }
                        }
                    }
                } else if (item.code === deptCode) {
                    return item;
                }
            }
            return null;
        }

        function openAssessmentForCurrent() {
            if (isCompanyOverallSelected) {
                alert("Please select a specific department to open its assessment.");
                return;
            }
            
            if (!currentAdminDeptCode) {
                alert("No department selected.");
                return;
            }
            
            // Save department code to session storage for the assessment page
            sessionStorage.setItem('assessment_dept', currentAdminDeptCode);
            
            // Open assessment in new tab
            window.open('index.html', '_blank');
        }

        function handleLogout() {
            sessionStorage.removeItem('tasheer_user_ent_v3');
            window.location.href = 'login.html';
        }

        function showOrgStructureView() {
            const modal = document.getElementById('orgStructureModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeOrgStructureModal() {
            const modal = document.getElementById('orgStructureModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('orgStructureModal');
            if (e.target === modal) {
                closeOrgStructureModal();
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initAdminDashboard);
    </script>
</body>
</html>