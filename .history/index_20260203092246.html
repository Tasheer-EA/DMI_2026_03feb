<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasheer DMI 2026 | Enterprise Edition</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Cairo font (Arabic-friendly) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- Tasheer favicon -->
    <link rel="icon" href="assets/img/tasheer-logo.png" type="image/png">
    <!-- Chart.js for Executive Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- LIGHT THEME VARIABLES --- */
        :root {
            --sidebar-width: 340px;
            --sidebar-bg: #ffffff;
            --sidebar-text: #4b5563;
            --accent-color: #3b82f6;
            --bg-body: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --hover-bg: #f3f4f6;
        }

        /* wider sidebar adjustments */
        .brand-img { height: 44px; width: auto; display: block; }
        .brand-logo { gap: 14px; }

        body {
            background-color: var(--bg-body);
            font-family: 'Cairo', system-ui, -apple-system, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #1f2937;
            font-weight: 400;
        }

        /* --- LOGIN --- */
        #login-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            transition: opacity 0.5s ease;
        }
        .login-card {
            background: white;
            border-radius: 12px; width: 100%; max-width: 400px; padding: 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        .login-card .form-control { 
            border: 1px solid #d1d5db; 
            padding: 12px;
            transition: all 0.2s;
        }
        .login-card .form-control:focus { 
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* --- LAYOUT --- */
        #app-wrapper { display: flex; height: 100%; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        #app-wrapper.active { opacity: 1; pointer-events: auto; }

        .sidebar {
            width: var(--sidebar-width); 
            background-color: var(--sidebar-bg); 
            color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 20px;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
        }
        .brand-logo { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #111827; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .brand-img { height: 36px; width: auto; display: block; }
        .report-logo { height: 40px; width: auto; display: block; }
        .small-logo { height: 18px; width: auto; display: inline-block; vertical-align: middle; }
        @media print { .report-logo { height: 48px; } .brand-img { height: 48px; } }

        /* Cairo font defaults: non-bold typography */
        .fw-bold { font-weight: 400 !important; }
        strong, b { font-weight: 400; }
        h1, h2, h3, h4, h5, h6 { font-weight: 400; }
        .btn, .nav-link, .brand-logo, .ms-btn { font-weight: 400; }
        
        .nav-link {
            color: var(--sidebar-text); 
            padding: 12px 16px; 
            border-radius: 8px;
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            transition: all 0.2s; 
            font-weight: 500;
            border: 1px solid transparent;
        }
        .nav-link:hover { 
            background-color: var(--hover-bg); 
            color: #111827; 
            border-color: var(--border-color);
        }
        .nav-link.active { 
            background-color: var(--accent-color); 
            color: white; 
            border-color: var(--accent-color);
        }

        /* --- SIDEBAR ACCORDION --- */
        .section-toggle { cursor: pointer; display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; background: transparent; border: none; width: 100%; color: var(--sidebar-text); font-weight: 600; }
        .section-toggle:hover { background-color: #eef2ff; color: var(--accent-color); }
        .section-toggle .chev { margin-left: auto; transition: transform 0.2s ease; }
        .section-toggle.open .chev { transform: rotate(180deg); color: var(--accent-color); }
        .sub-links { overflow: hidden; max-height: 0; transition: max-height 0.25s ease; display:block; padding-left: 8px; }
        .sub-links.open { max-height: 1000px; }
        .nav-link.sub-link { padding: 8px 14px; font-size: 0.95rem; }
        .dim-badge { background: var(--accent-color); color: #fff; padding: 4px 8px; border-radius: 999px; font-size: 0.75rem; margin-left: 8px; }

        /* per-dimension icon */
        .dim-icon { width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; background: rgba(59,130,246,0.06); margin-right: 10px; font-size: 1.1rem; }
        .dim-icon.text-primary { background: rgba(59,130,246,0.08); }
        .dim-icon.text-success { background: rgba(16,185,129,0.06); }
        .dim-icon.text-danger { background: rgba(239,68,68,0.06); }
        .dim-icon.text-warning { background: rgba(245,158,11,0.06); }
        .dim-icon.text-info { background: rgba(14,165,233,0.06); }

        .main-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 30px; 
            background-color: var(--bg-body);
        }

        /* --- CARDS & CHARTS --- */
        .stat-card { 
            background: white; 
            border-radius: 12px; 
            padding: 24px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: 100%; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* --- TABLE (Library) --- */
        .custom-table-container { 
            background: white; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .table th { 
            background: #f9fafb; 
            border-bottom: 2px solid var(--border-color); 
            font-weight: 600; 
            color: #374151; 
            padding: 16px;
        }
        .table td {
            padding: 16px;
            border-color: var(--border-color);
        }
        .table-hover tbody tr:hover { 
            background-color: #f8fafc; 
            cursor: pointer; 
        }

        /* --- ASSESSMENT --- */
        .maturity-scale { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; justify-content: flex-start; }
        .ms-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 10px; min-width: 68px; border-radius: 8px; border: 1px solid var(--border-color);
            background: white; text-align: left; cursor: pointer; transition: all 0.12s; font-size: 0.85rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .ms-btn strong { font-size: 0.95rem; display:inline-block; width:22px; text-align:center; }
        .ms-btn small { font-size: 0.75rem; color: #6b7280; display:inline-block; margin-left:4px; }
        .ms-btn.selected { color: white; border-color: transparent; }
        .ms-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            border-color: var(--accent-color);
        }
        .ms-btn.selected { 
            color: white; 
            border-color: transparent;
        }
        .ms-btn.level-0.selected { background: #ef4444; }
        .ms-btn.level-1.selected { background: #f97316; }
        .ms-btn.level-2.selected { background: #eab308; }
        .ms-btn.level-3.selected { background: #22c55e; }
        .ms-btn.level-4.selected { background: #3b82f6; }
        .ms-btn.level-5.selected { background: #0f172a; }

        /* --- BUTTONS --- */
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .btn-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-1px);
        }
        .btn-outline-primary {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .btn-outline-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* --- ALERTS --- */
        .alert {
            border-radius: 8px;
            border: 1px solid;
        }
        .alert-light {
            background-color: #f9fafb;
            border-color: var(--border-color);
            color: #4b5563;
        }
        .alert-info {
            background-color: #f0f9ff;
            border-color: #bae6fd;
            color: #0369a1;
        }

        /* --- BADGES --- */
        .badge {
            border-radius: 6px;
            padding: 6px 10px;
            font-weight: 500;
        }

        /* --- PROGRESS BAR --- */
        .progress {
            border-radius: 6px;
            background-color: #e5e7eb;
            height: 8px;
        }
        .progress-bar {
            border-radius: 6px;
        }

        /* --- MODAL --- */
        .modal-content {
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background-color: #f9fafb;
            border-radius: 12px 12px 0 0;
        }

        .hidden { display: none !important; }

        /* --- UTILITIES --- */
        .text-muted { color: #6b7280 !important; }
        .text-secondary { color: #4b5563 !important; }
        .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important; }
        
        /* --- LIST ITEMS --- */
        .list-group-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .list-group-item:hover {
            background-color: #f8fafc;
            border-color: var(--accent-color);
            transform: translateX(0);
        }

        /* --- DIMENSIONS LIST (Assessments) --- */
        .dim-item { background: white; border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .dim-item h6 { margin: 0; }
        .dim-pillar { margin-top: 8px; display: flex; flex-direction: column; gap: 6px; }
        .dim-pillar a { color: #374151; text-decoration: none; padding: 6px 8px; border-radius: 6px; display: inline-block; }
        .dim-pillar a:hover { background: var(--hover-bg); color: var(--accent-color); text-decoration: none; }
        
        /* --- FORM CONTROLS --- */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 10px 12px;
            transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>



    <!-- APP WRAPPER -->
    <div id="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand-logo"><img src="assets/img/tasheer-logo.png" alt="Tasheer" class="brand-img" onerror="this.onerror=null; this.src='assets/img/tasheer-logo.svg'"><span>DMI Enterprise</span></div>
            
            <nav id="sidebar-nav" class="d-flex flex-column flex-grow-1">
                <a href="#" class="nav-link active" onclick="renderDashboardExec()"><i class="bi bi-bar-chart-line"></i> Analytics</a>
                <a href="#" class="nav-link" onclick="renderDashboard()"><i class="bi bi-layers"></i> Assessments</a>
                <div id="sidebar-dims"></div>
                <a href="#" id="nav-library" class="nav-link" onclick="renderLibrary()"><i class="bi bi-collection"></i> Question Library</a>
                <a href="#" id="nav-auditor" class="nav-link" onclick="renderAuditor()"><i class="bi bi-pencil-square"></i> Audit Mode</a>

                <hr>
            </nav>

            <div class="user-profile text-dark small">
                            
                <div class="fw-bold" id="sidebar-username">Admin</div>
                <div class="text-muted mb-2" id="sidebar-role">System Admin</div>
                <a href="#" onclick="handleLogout()" class="text-danger small text-decoration-none"><i class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="print-header d-none d-print-block">
                <img src="assets/img/tasheer-logo.png" class="report-logo" alt="Tasheer" onerror="this.onerror=null; this.src='assets/img/tasheer-logo.svg'">
            </div>
            
            <!-- Top Bar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <nav aria-label="breadcrumb"><ol class="breadcrumb mb-0" id="main-breadcrumb"><li class="breadcrumb-item"><img src="assets/img/tasheer-logo.png" class="small-logo me-2" alt="Tasheer" onerror="this.onerror=null;this.src='assets/img/tasheer-logo.svg'">Home</li></ol></nav>
                <button class="btn btn-outline-primary btn-sm" onclick="exportDataToFile()"><i class="bi bi-download"></i> Export JSON</button>
            </div>

            <!-- VIEW 1: EXECUTIVE DASHBOARD (Charts) -->
            <div id="view-dashboard-exec">
                <h2 class="fw-bold mb-4">Executive Overview</h2>
                
                <!-- Key Metrics -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-primary me-3"><i class="bi bi-activity"></i></div>
                            <div>
                                <div class="text-muted small">Total Score</div>
                                <div class="fs-3 fw-bold" id="exec-total-score">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-success me-3"><i class="bi bi-check-circle"></i></div>
                            <div>
                                <div class="text-muted small">Completion</div>
                                <div class="fs-3 fw-bold" id="exec-completion">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-warning me-3"><i class="bi bi-list-check"></i></div>
                            <div>
                                <div class="text-muted small">Questions</div>
                                <div class="fs-3 fw-bold" id="exec-total-q">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-danger me-3"><i class="bi bi-exclamation-triangle"></i></div>
                            <div>
                                <div class="text-muted small">Alerts</div>
                                <div class="fs-3 fw-bold">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card mb-4">
                            <h6 class="fw-bold mb-3">Maturity by Dimension</h6>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="stat-card">
                            <h6 class="fw-bold mb-3">Maturity Radar</h6>
                            <div class="chart-container">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ASSESSMENT NAVIGATION (Drilldown) -->
            <div id="view-dashboard" class="hidden">
                <h2 class="fw-bold mb-1">Assessments</h2>
                <p class="text-muted mb-2">Select a dimension to begin.</p>
                <h4 class="fw-bold mb-3"><i class="bi bi-list me-2"></i>Dimensions &amp; Focus Areas</h4>
                <div class="row g-4" id="dimensions-grid"></div>
            </div>

            <!-- VIEW 3: QUESTION LIBRARY (Flat Table) -->
            <div id="view-library" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Question Library</h2>
                    <div>
                        <input type="text" class="form-control d-inline-block w-auto me-2" placeholder="Search questions..." id="lib-search" onkeyup="filterLibrary()">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQModal"><i class="bi bi-plus-lg"></i> New</button>
                    </div>
                </div>
                <div class="custom-table-container">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Dimension</th>
                                <th>Question Text</th>
                                <th>Group</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="library-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW 4: LIST (Pillars/Groups) -->
            <div id="view-list" class="hidden">
                <h3 class="fw-bold mb-3" id="list-title">Selection</h3>
                <div class="custom-table-container" id="list-container"></div>
            </div>

            <!-- VIEW 5: ASSESSMENT (Questions) -->
            <div id="view-assessment" class="hidden">
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <h2 class="fw-bold">Assessment</h2>
                        <p class="text-muted" id="assessment-subtitle">Group Name</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <button class="btn btn-primary px-4" onclick="saveCurrentAssessment()">Save Progress</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8" id="questions-container"></div>
                    <div class="col-lg-4">
                        <div class="stat-card sticky-top" style="top: 20px; z-index: 10;">
                            <h6 class="fw-bold mb-3">Session Progress</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Answered</span>
                                <span class="fw-bold" id="summary-answered">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div id="summary-bar" class="progress-bar bg-primary" style="width: 0%"></div>
                            </div>
                            <div class="alert alert-light small border">
                                <strong>Tip:</strong> Click levels to select. Selecting a low score may prompt for comments.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: AUDITOR MODE (Add Question) -->
            <div id="view-auditor" class="hidden">
                <h2 class="fw-bold mb-4">Auditor Dashboard</h2>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> The <strong>Question Library</strong> tab above now offers a master view for easier management. Use this page for rapid structural additions.
                </div>
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">Rapid Question Entry</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <select class="form-select" id="audit-dim" onchange="loadAuditPillars()"></select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="audit-pillar" onchange="loadAuditGroups()"></select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="audit-group"></select>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <textarea class="form-control" id="audit-q-text" rows="2" placeholder="Question Text"></textarea>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="text" id="audit-l0" class="form-control form-control-sm" placeholder="L0: None"></div>
                        <div class="col-6"><input type="text" id="audit-l1" class="form-control form-control-sm" placeholder="L1: Initial"></div>
                        <div class="col-6"><input type="text" id="audit-l2" class="form-control form-control-sm" placeholder="L2: Dev"></div>
                        <div class="col-6"><input type="text" id="audit-l3" class="form-control form-control-sm" placeholder="L3: Def"></div>
                        <div class="col-6"><input type="text" id="audit-l4" class="form-control form-control-sm" placeholder="L4: Mng"></div>
                        <div class="col-6"><input type="text" id="audit-l5" class="form-control form-control-sm" placeholder="L5: Opt"></div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="submitAuditorForm()">Add Question</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Question Modal (For Library) -->
    <div class="modal fade" id="addQModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add to Library</h5></div>
                <div class="modal-body">
                    <form id="lib-form">
                        <div class="mb-3">
                            <label class="form-label">Dimension</label>
                            <select class="form-select" id="lib-dim" onchange="loadLibPillars()"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pillar</label>
                            <select class="form-select" id="lib-pillar" onchange="loadLibGroups()"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Group</label>
                            <select class="form-select" id="lib-group"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question</label>
                            <textarea class="form-control" id="lib-q-text" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitLibForm()">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. DATA & CONFIG ---
        const standardGroups = [
            { id: 'strategy', name: 'Strategy' },
            { id: 'capability', name: 'Capability' },
            { id: 'operation', name: 'Operation' },
            { id: 'services', name: 'Services' },
            { id: 'technology', name: 'Technology' },
            { id: 'beneficiary', name: 'Beneficiary' }
        ];

        const seedData = [
            { id: 'ext_app', name: '1- External Application ', points: 40, pillars: [
                { id: 'tasheer_branch_apps', name: '1.1 - Tasheer branch applications', groups: JSON.parse(JSON.stringify(standardGroups)) },
                { id: 'national_integrations', name: '1.2 - National platform integrations', groups: JSON.parse(JSON.stringify(standardGroups)) }
            ] },
            { id: 'int_app', name: '2- Internal Applications ', points: 40, pillars: [
                { id: 'sap_erp', name: '2.1 - SAP ERP and enterprise modules', groups: JSON.parse(JSON.stringify(standardGroups)) },
                { id: 'itsm_onclick', name: '2.2 - ITSM services through OnClick', groups: JSON.parse(JSON.stringify(standardGroups)) }
            ] },
            { id: 'sec', name: '3- Security & Compliance ', points: 20, pillars: [
                { id: 'regulatory_alignment', name: '3.1 - Regulatory alignment', groups: JSON.parse(JSON.stringify(standardGroups)) },
                { id: 'continuous_monitoring', name: '3.2 - Continuous monitoring', groups: JSON.parse(JSON.stringify(standardGroups)) }
            ] },
            { id: 'mon', name: '4- Monitoring & Controls ', points: 40, pillars: [
                { id: 'dev_ops_coverage', name: '4.1 - Development to operations coverage', groups: JSON.parse(JSON.stringify(standardGroups)) },
                { id: 'system_observability', name: '4.2 - System observability and Infrastructure usage', groups: JSON.parse(JSON.stringify(standardGroups)) }
            ] },
            { id: 'inn', name: '5- Innovation & Edge Tech ', points: 10, pillars: [
                { id: 'emerging_tech', name: '5.1 - Emerging technologies', groups: JSON.parse(JSON.stringify(standardGroups)) },
                { id: 'edge_computing', name: '5.2 - Edge computing', groups: JSON.parse(JSON.stringify(standardGroups)) }
            ] }
        ];

        let appData = [];
        let userResponses = {};
        let currentUser = null;
        let currentPath = { dimIdx: null, pillarIdx: null, groupIdx: null };
        let charts = {};

        // --- 2. INITIALIZATION ---
        async function loadData() {
            const stored = localStorage.getItem('tasheer_dmi_ent_v3');
            if (stored) return JSON.parse(stored);
            try {
                const response = await fetch('./tasheer_data.json');
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('tasheer_dmi_ent_v3', JSON.stringify(data));
                    return data;
                }
            } catch (e) {}
            return seedData;
        }

        async function initApp() {
            appData = await loadData();
            seedStructureOnly();
            saveData();

            const storedResponses = localStorage.getItem('tasheer_resp_ent_v3');
            if (storedResponses) userResponses = JSON.parse(storedResponses);

            let userSession = sessionStorage.getItem('tasheer_user_ent_v3');
            if (userSession) {
                currentUser = JSON.parse(userSession);
            } else {
                currentUser = { username: 'Admin', role: 'admin' };
                sessionStorage.setItem('tasheer_user_ent_v3', JSON.stringify(currentUser));
            }
            showApp();
        }

        function seedStructureOnly() {
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        if (!group.questions) group.questions = [];
                    });
                });
            });
        }

        // --- 3. CORE UI LOGIC ---
        function saveData() { localStorage.setItem('tasheer_dmi_ent_v3', JSON.stringify(appData)); }
        function saveResponses() { localStorage.setItem('tasheer_resp_ent_v3', JSON.stringify(userResponses)); }



        function showApp() {
            const loginContainer = document.getElementById('login-container');
            if (loginContainer) {
                loginContainer.style.opacity = '0';
                setTimeout(() => { loginContainer.classList.add('hidden'); }, 500);
            }
            const appWrap = document.getElementById('app-wrapper'); if (appWrap) appWrap.classList.add('active');
            const sbUser = document.getElementById('sidebar-username'); if (sbUser && currentUser) sbUser.innerText = currentUser.username;
            if (currentUser && currentUser.role !== 'admin') {
                const navLibrary = document.getElementById('nav-library'); if (navLibrary) navLibrary.classList.add('hidden');
                const navAuditor = document.getElementById('nav-auditor'); if (navAuditor) navAuditor.classList.add('hidden');
            }
            renderSidebar();
            renderDashboardExec();
        }

        function handleLogout() { sessionStorage.removeItem('tasheer_user_ent_v3'); location.reload(); }
        
        const fileInputEl = document.getElementById('file-input');
        if (fileInputEl) {
            fileInputEl.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            appData = json; seedStructureOnly(); saveData();
                            alert("Imported!");
                        }
                    } catch (err) { alert("Invalid JSON"); }
                };
                reader.readAsText(file);
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('[id^="view-dashboard"], [id^="view-list"], [id^="view-assessment"], [id^="view-library"], [id^="view-auditor"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function setActiveNav(id) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if(id) document.getElementById(id).classList.add('active');
        }

        // --- SIDEBAR RENDERING ---
        const dimMeta = {
            'ext_app': { icon: 'bi-cloud', color: 'text-primary' },
            'int_app': { icon: 'bi-stack', color: 'text-success' },
            'sec': { icon: 'bi-shield-lock', color: 'text-danger' },
            'mon': { icon: 'bi-speedometer2', color: 'text-warning' },
            'inn': { icon: 'bi-lightning-charge', color: 'text-info' }
        };

        function renderSidebar() {
            const container = document.getElementById('sidebar-dims');
            if (!container) return;
            container.innerHTML = '';
            appData.forEach((dim, dIdx) => {
                const meta = dimMeta[dim.id] || {};
                const iconClass = meta.icon ? `bi ${meta.icon}` : 'bi bi-shield-fill';
                const colorClass = meta.color || '';

                const section = document.createElement('div');
                section.className = 'mb-2';
                section.innerHTML = `
                    <button class="section-toggle" data-didx="${dIdx}" onclick="toggleDim(this)">
                        <span><i class="dim-icon ${iconClass} ${colorClass}"></i> <strong>${dim.name}</strong></span>
                        <i class="chev bi bi-chevron-down"></i>
                    </button> 
                    <div class="sub-links" id="sub-dim-${dIdx}">${dim.pillars.map((p,i)=>`<a href="#" class="nav-link sub-link pillar-link" onclick="renderGroups(${dIdx}, ${i});return false;"><i class="bi bi-dot"></i> ${p.name}</a>`).join('')}</div>
                `;
                container.appendChild(section);
            });
        }

        function toggleDim(btn) {
            const dIdx = btn.getAttribute('data-didx');
            const sub = document.getElementById(`sub-dim-${dIdx}`);
            if (!sub) return;
            const open = sub.classList.toggle('open');
            btn.classList.toggle('open', open);
            if (open) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- 4. EXECUTIVE DASHBOARD (Analytics) ---
        function renderDashboardExec() {
            switchView('view-dashboard-exec');
            setActiveNav();

            let totalQ = 0;
            let answeredQ = 0;
            let totalScore = 0;
            let dimScores = [];
            let dimLabels = [];

            appData.forEach(dim => {
                let dimMax = dim.points * 5;
                let dimRawSum = 0;
                let dimCount = 0;

                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions.forEach(q => {
                            totalQ++;
                            if(userResponses[q.id] !== undefined) {
                                answeredQ++;
                                const score = parseInt(userResponses[q.id]);
                                dimRawSum += score;
                                dimCount++;
                            }
                        });
                    });
                });

                let weightedScore = 0;
                if(dimCount > 0) {
                    const avgLevel = dimRawSum / dimCount;
                    weightedScore = (avgLevel / 5) * dim.points;
                }
                
                dimScores.push(weightedScore);
                dimLabels.push(dim.name);
                totalScore += weightedScore;
            });

            document.getElementById('exec-total-score').innerText = Math.round(totalScore);
            document.getElementById('exec-completion').innerText = Math.round((answeredQ/totalQ)*100) + '%';
            document.getElementById('exec-total-q').innerText = totalQ;

            renderCharts(dimScores, dimLabels);
        }

        function renderCharts(data, labels) {
            const barCtx = document.getElementById('barChart').getContext('2d');
            const radarCtx = document.getElementById('radarChart').getContext('2d');

            if(charts.bar) charts.bar.destroy();
            if(charts.radar) charts.radar.destroy();

            charts.bar = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Score',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 50,
                            grid: { color: '#e5e7eb' },
                            ticks: { color: '#6b7280' }
                        },
                        x: {
                            grid: { color: '#e5e7eb' },
                            ticks: { color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#6b7280' } }
                    }
                }
            });

            charts.radar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Maturity',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        r: { 
                            beginAtZero: true,
                            grid: { color: '#e5e7eb' },
                            angleLines: { color: '#e5e7eb' },
                            pointLabels: { color: '#6b7280' },
                            ticks: { backdropColor: 'transparent', color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#6b7280' } }
                    }
                }
            });
        }

        // --- 5. QUESTION LIBRARY ---
        function renderLibrary() {
            switchView('view-library');
            setActiveNav('nav-library');
            filterLibrary();
        }

        function filterLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const tbody = document.getElementById('library-tbody');
            tbody.innerHTML = '';

            appData.forEach((dim, dIdx) => {
                dim.pillars.forEach((pillar, pIdx) => {
                    pillar.groups.forEach((group, gIdx) => {
                        group.questions.forEach((q, qIdx) => {
                            if(q.text.toLowerCase().includes(term)) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td class="small text-muted">${q.id}</td>
                                    <td>${dim.name}</td>
                                    <td>${q.text}</td>
                                    <td><span class="badge bg-light text-dark border">${group.name}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion('${q.id}')"><i class="bi bi-trash"></i></button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            }
                        });
                    });
                });
            });
            if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No questions found.</td></tr>';
        }

        function deleteQuestion(id) {
            if(!confirm("Delete this question?")) return;
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions = group.questions.filter(q => q.id !== id);
                    });
                });
            });
            saveData();
            filterLibrary();
            showToast("Question deleted.");
        }

        function loadLibPillars() {
            const dIdx = document.getElementById('lib-dim').value;
            const pSelect = document.getElementById('lib-pillar');
            pSelect.innerHTML = '';
            if(dIdx !== "") appData[dIdx].pillars.forEach((p, i) => pSelect.innerHTML += `<option value="${i}">${p.name}</option>`);
        }
        function loadLibGroups() {
            const dIdx = document.getElementById('lib-dim').value;
            const pIdx = document.getElementById('lib-pillar').value;
            const gSelect = document.getElementById('lib-group');
            gSelect.innerHTML = '';
            if(dIdx !== "" && pIdx !== "") appData[dIdx].pillars[pIdx].groups.forEach((g, i) => gSelect.innerHTML += `<option value="${i}">${g.name}</option>`);
        }
        function submitLibForm() {
            const dIdx = document.getElementById('lib-dim').value;
            const pIdx = document.getElementById('lib-pillar').value;
            const gIdx = document.getElementById('lib-group').value;
            const text = document.getElementById('lib-q-text').value;
            
            if(dIdx==="" || pIdx==="" || gIdx==="" || !text) return alert("Fill all fields");

            const newQ = {
                id: Date.now().toString(),
                text: text,
                levels: ["Non-Existent", "Initial", "Developing", "Defined", "Managed", "Optimized"]
            };
            appData[dIdx].pillars[pIdx].groups[gIdx].questions.push(newQ);
            saveData();
            
            const modalEl = document.getElementById('addQModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            filterLibrary();
            showToast("Added to Library");
        }

        // --- 6. ASSESSMENT NAVIGATION ---
        function renderDashboard() {
            switchView('view-dashboard');
            setActiveNav();
            const grid = document.getElementById('dimensions-grid');
            grid.innerHTML = '';
            appData.forEach((dim, index) => {
                grid.innerHTML += `
                    <div class="col-12">
                        <div class="dim-item">
                            <div>
                                <h6 class="fw-bold mb-0">${dim.name}</h6>
                            </div>
                            <div class="dim-pillar">
                                ${dim.pillars.map((p, pIdx) => `<a href="#" onclick="renderGroups(${index}, ${pIdx}); return false;">${p.name}</a>`).join('')}
                            </div>
                        </div>
                    </div>`;
            });
        }

        function renderPillars(dimIdx) {
            currentPath.dimIdx = dimIdx;
            switchView('view-list');
            const dim = appData[dimIdx];
            document.getElementById('list-title').innerText = `${dim.name} : Key Focus Areas`;
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            dim.pillars.forEach((pillar, pIdx) => {
                container.innerHTML += `<div class="list-group-item list-item p-3" onclick="renderGroups(${dimIdx}, ${pIdx})"><h6 class="fw-bold mb-0">${pillar.name}</h6><small class="text-muted">6 Groups</small></div>`;
            });
        }

        function renderGroups(dimIdx, pillarIdx) {
            currentPath.pillarIdx = pillarIdx;
            switchView('view-list');
            const pillar = appData[dimIdx].pillars[pillarIdx];
            document.getElementById('list-title').innerText = `${pillar.name} : Assessment Groups`;
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            pillar.groups.forEach((group, gIdx) => {
                let qCount = group.questions.length;
                let answered = group.questions.filter(q => userResponses[q.id] !== undefined).length;
                container.innerHTML += `
                    <div class="list-group-item list-item p-3" onclick="renderQuestions(${dimIdx}, ${pillarIdx}, ${gIdx})">
                        <div>
                            <h6 class="fw-bold mb-1">${group.name} <span class="badge bg-light text-dark ms-2">${answered}/${qCount}</span></h6>
                        </div>
                    </div>`;
            });
        }

        function renderQuestions(dimIdx, pillarIdx, groupIdx) {
            currentPath.groupIdx = groupIdx;
            switchView('view-assessment');
            const group = appData[dimIdx].pillars[pillarIdx].groups[groupIdx];
            document.getElementById('assessment-subtitle').innerText = `${appData[dimIdx].name} > ${appData[dimIdx].pillars[pillarIdx].name} > ${group.name}`;
            
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            if(!group.questions.length) {
                container.innerHTML = '<div class="alert alert-warning">No questions available.</div>'; return;
            }

            let total = group.questions.length;
            let answered = 0;

            group.questions.forEach((q, qIdx) => {
                if(userResponses[q.id] !== undefined) answered++;
                const saved = userResponses[q.id];
                const card = document.createElement('div');
                card.className = 'stat-card mb-3 p-3';
                
                let buttons = '';
                q.levels.forEach((l, i) => {
                    const cl = saved == i ? 'selected level-'+i : '';
                    const label = (l.length > 12) ? l.substring(0,12) + 'â€¦' : l;
                    buttons += `<div class="ms-btn ${cl}" onclick="setScore('${q.id}', ${i})"><strong>${i}</strong><small>${label}</small></div>`;
                });

                card.innerHTML = `
                    <h6 class="fw-bold mb-2">Q${qIdx+1}: ${q.text}</h6>
                    <div class="maturity-scale">${buttons}</div>
                `;
                container.appendChild(card);
            });

            document.getElementById('summary-answered').innerText = answered;
            document.getElementById('summary-bar').style.width = (answered/total*100) + '%';
        }

        function setScore(qId, level) {
            userResponses[qId] = level;
            saveResponses();
            renderQuestions(currentPath.dimIdx, currentPath.pillarIdx, currentPath.groupIdx);
        }

        function saveCurrentAssessment() {
            saveResponses();
            showToast("Progress Saved");
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = 'position-fixed bottom-0 end-0 p-3';
            div.style.zIndex = 2000;
            div.innerHTML = `<div class="toast show bg-dark text-white"><div class="toast-body">${msg}</div></div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // --- 7. AUDITOR MODE ---
        function renderAuditor() {
            switchView('view-auditor');
            const dimSelect = document.getElementById('audit-dim');
            dimSelect.innerHTML = '';
            appData.forEach((d, i) => { dimSelect.innerHTML += `<option value="${i}">${d.name}</option>`; });
        }
        function loadAuditPillars() {
            const dIdx = document.getElementById('audit-dim').value;
            const pSelect = document.getElementById('audit-pillar');
            pSelect.innerHTML = '';
            if(dIdx !== "") appData[dIdx].pillars.forEach((p, i) => pSelect.innerHTML += `<option value="${i}">${p.name}</option>`);            
            document.getElementById('audit-group').innerHTML = '';
        }
        function loadAuditGroups() {
            const dIdx = document.getElementById('audit-dim').value;
            const pIdx = document.getElementById('audit-pillar').value;
            const gSelect = document.getElementById('audit-group');
            gSelect.innerHTML = '';
            if(dIdx !== "" && pIdx !== "" && appData[dIdx] && appData[dIdx].pillars[pIdx]) {
                appData[dIdx].pillars[pIdx].groups.forEach((g, i) => gSelect.innerHTML += `<option value="${i}">${g.name}</option>`);
            }
        }
        function submitAuditorForm() {
            const dIdx = document.getElementById('audit-dim').value;
            const pIdx = document.getElementById('audit-pillar').value;
            const gIdx = document.getElementById('audit-group').value;
            const text = document.getElementById('audit-q-text').value;
            if(dIdx===""||pIdx===""||gIdx===""||!text) return alert("Fill fields");
            
            const newQ = {
                id: Date.now().toString(),
                text: text,
                levels: ["None","Basic","Dev","Def","Mng","Opt"]
            };
            appData[dIdx].pillars[pIdx].groups[gIdx].questions.push(newQ);
            saveData();
            document.getElementById('audit-q-text').value = '';
            showToast("Added");
        }
        function exportDataToFile() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "tasheer_data.json";
            a.click();
        }

        // Start
        function createConfigModal(){
            const html = `
            <div class="modal fade" id="configModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header"><h5 class="modal-title">Configuration</h5></div>
                        <div class="modal-body" id="config-body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="config-save-btn">Save Configuration</button>
                        </div>
                    </div>
                </div>
            </div>`;
            const tmp = document.createElement('div'); tmp.innerHTML = html; document.body.appendChild(tmp);
        }

        async function openConfig() {
            const modalEl = document.getElementById('configModal');
            const modal = new bootstrap.Modal(modalEl);
            await loadConfig();
            modal.show();
        }

        async function loadConfig() {
            let cfg = null;
            try {
                const resp = await fetch('/get-config');
                if (resp.ok) cfg = await resp.json();
            } catch (e) {}
            if (!cfg) {
                const s = localStorage.getItem('tasheer_config');
                if (s) cfg = JSON.parse(s);
            }
            if (!cfg) cfg = appData;
            renderConfigForm(cfg);
        }

        function renderConfigForm(cfg) {
            const body = document.getElementById('config-body');
            body.innerHTML = '';
            cfg.forEach((dim, dIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-3 p-3 border rounded';
                wrapper.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <input class="form-control me-2 cfg-dname" data-didx="${dIdx}" value="${escapeHtml(dim.name)}" placeholder="Dimension name">
                        <input class="form-control me-2 cfg-dpoints" data-didx-points="${dIdx}" value="${dim.points||0}" style="width:110px">
                    </div>
                    <div class="pillars-container" data-didx="${dIdx}">
                        ${dim.pillars.map((p,pIdx)=>`
                            <div class="mb-2 d-flex align-items-center">
                                <input class="form-control me-2 cfg-pname" data-didx="${dIdx}" data-pidx="${pIdx}" value="${escapeHtml(p.name)}">
                            </div>
                        `).join('')}
                    </div>
                `;
                body.appendChild(wrapper);
            });
            const saveBtn = document.getElementById('config-save-btn');
            saveBtn.onclick = saveConfig;
        }

        function collectConfigFromForm() {
            const body = document.getElementById('config-body');
            const dims = [];
            body.querySelectorAll('.cfg-dname').forEach(input => {
                const dIdx = input.getAttribute('data-didx');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].name = input.value;
            });
            body.querySelectorAll('.cfg-dpoints').forEach(input => {
                const dIdx = input.getAttribute('data-didx-points');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].points = parseInt(input.value) || 0;
            });
            body.querySelectorAll('.cfg-pname').forEach(input => {
                const dIdx = input.getAttribute('data-didx');
                const pIdx = input.getAttribute('data-pidx');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].pillars[pIdx] = { name: input.value, groups: JSON.parse(JSON.stringify(standardGroups)) };
            });
            return dims.map(d => ({ id: d.name.toLowerCase().replace(/\s+/g,'_'), name: d.name, points: d.points, pillars: d.pillars.map(p=>p||{name:'Unnamed',groups:JSON.parse(JSON.stringify(standardGroups))}) }));
        }

        async function saveConfig() {
            const cfg = collectConfigFromForm();
            try {
                const resp = await fetch('/save-config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) });
                if (resp.ok) {
                    showToast('Saved to server');
                    appData = cfg; seedStructureOnly(); saveData(); renderSidebar();
                    const modalEl = document.getElementById('configModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    return;
                }
            } catch (e) {}
            localStorage.setItem('tasheer_config', JSON.stringify(cfg));
            appData = cfg; seedStructureOnly(); saveData(); renderSidebar();
            showToast('Saved locally (no server)');
            const modalEl = document.getElementById('configModal');
            bootstrap.Modal.getInstance(modalEl).hide();
        }

        function escapeHtml(str) { if (!str) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll("'","&#39;"); }

        document.addEventListener('DOMContentLoaded', function(){ initApp(); createConfigModal(); });

    </script>
</body>
</html>