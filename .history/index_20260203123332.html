<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasheer DMI 2026 | Enterprise Edition</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Cairo font (Arabic-friendly) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- Tasheer favicon -->
    <link rel="icon" href="assets/img/tasheer-logo.png" type="image/png">
    <!-- Chart.js for Executive Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- LIGHT THEME VARIABLES --- */
        :root {
            --sidebar-width: 340px;
            --sidebar-bg: #ffffff;
            --sidebar-text: #4b5563;
            --accent-color: #3b82f6;
            --bg-body: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --hover-bg: #f3f4f6;
        }

        /* wider sidebar adjustments */
        .brand-img {
            height: 44px;
            width: auto;
            display: block;
        }

        .brand-logo {
            gap: 14px;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Cairo', system-ui, -apple-system, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            color: #1f2937;
            font-weight: 400;
        }

        /* --- LOGIN --- */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .login-card .form-control {
            border: 1px solid #d1d5db;
            padding: 12px;
            transition: all 0.2s;
        }

        .login-card .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* --- LAYOUT --- */
        #app-wrapper {
            display: flex;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #app-wrapper.active {
            opacity: 1;
            pointer-events: auto;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .brand-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-img {
            height: 36px;
            width: auto;
            display: block;
        }

        .report-logo {
            height: 40px;
            width: auto;
            display: block;
        }

        .small-logo {
            height: 18px;
            width: auto;
            display: inline-block;
            vertical-align: middle;
        }

        @media print {
            .report-logo {
                height: 48px;
            }

            .brand-img {
                height: 48px;
            }
        }

        /* Cairo font defaults: non-bold typography */
        .fw-bold {
            font-weight: 400 !important;
        }

        strong,
        b {
            font-weight: 400;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 400;
        }

        .btn,
        .nav-link,
        .brand-logo,
        .ms-btn {
            font-weight: 400;
        }

        .nav-link {
            color: var(--sidebar-text);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .nav-link:hover {
            background-color: var(--hover-bg);
            color: #111827;
            border-color: var(--border-color);
        }

        .nav-link.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* --- SIDEBAR ACCORDION --- */
        .section-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            background: transparent;
            border: none;
            width: 100%;
            color: var(--sidebar-text);
            font-weight: 600;
        }

        .section-toggle:hover {
            background-color: #eef2ff;
            color: var(--accent-color);
        }

        .section-toggle .chev {
            margin-left: auto;
            transition: transform 0.2s ease;
        }

        .section-toggle.open .chev {
            transform: rotate(180deg);
            color: var(--accent-color);
        }

        .sub-links {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.25s ease;
            display: block;
            padding-left: 8px;
        }

        .sub-links.open {
            max-height: 1000px;
        }

        .nav-link.sub-link {
            padding: 8px 14px;
            font-size: 0.95rem;
        }

        .dim-badge {
            background: var(--accent-color);
            color: #fff;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        /* per-dimension icon */
        .dim-icon {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.06);
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .dim-icon.text-primary {
            background: rgba(59, 130, 246, 0.08);
        }

        .dim-icon.text-success {
            background: rgba(16, 185, 129, 0.06);
        }

        .dim-icon.text-danger {
            background: rgba(239, 68, 68, 0.06);
        }

        .dim-icon.text-warning {
            background: rgba(245, 158, 11, 0.06);
        }

        .dim-icon.text-info {
            background: rgba(14, 165, 233, 0.06);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background-color: var(--bg-body);
        }

        /* --- CARDS & CHARTS --- */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            height: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- TABLE (Library) --- */
        .custom-table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .table th {
            background: #f9fafb;
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: #374151;
            padding: 16px;
        }

        .table td {
            padding: 16px;
            border-color: var(--border-color);
        }

        .table-hover tbody tr:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }

        /* --- ASSESSMENT --- */
        .maturity-scale {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            justify-content: flex-start;
        }

        .ms-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            min-width: 68px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.12s;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ms-btn strong {
            font-size: 0.95rem;
            display: inline-block;
            width: 22px;
            text-align: center;
        }

        .ms-btn small {
            font-size: 0.75rem;
            color: #6b7280;
            display: inline-block;
            margin-left: 4px;
        }

        .ms-btn.selected {
            color: white;
            border-color: transparent;
        }

        .ms-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }

        .ms-btn.selected {
            color: white;
            border-color: transparent;
        }

        .ms-btn.level-0.selected {
            background: #ef4444;
        }

        .ms-btn.level-1.selected {
            background: #f97316;
        }

        .ms-btn.level-2.selected {
            background: #eab308;
        }

        .ms-btn.level-3.selected {
            background: #22c55e;
        }

        .ms-btn.level-4.selected {
            background: #3b82f6;
        }

        .ms-btn.level-5.selected {
            background: #0f172a;
        }

        /* --- BUTTONS --- */
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* --- ALERTS --- */
        .alert {
            border-radius: 8px;
            border: 1px solid;
        }

        .alert-light {
            background-color: #f9fafb;
            border-color: var(--border-color);
            color: #4b5563;
        }

        .alert-info {
            background-color: #f0f9ff;
            border-color: #bae6fd;
            color: #0369a1;
        }

        /* --- BADGES --- */
        .badge {
            border-radius: 6px;
            padding: 6px 10px;
            font-weight: 500;
        }

        /* --- PROGRESS BAR --- */
        .progress {
            border-radius: 6px;
            background-color: #e5e7eb;
            height: 8px;
        }

        .progress-bar {
            border-radius: 6px;
        }

        /* --- MODAL --- */
        .modal-content {
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background-color: #f9fafb;
            border-radius: 12px 12px 0 0;
        }

        .hidden {
            display: none !important;
        }

        /* --- UTILITIES --- */
        .text-muted {
            color: #6b7280 !important;
        }

        .text-secondary {
            color: #4b5563 !important;
        }

        .shadow-sm {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
        }

        /* --- LIST ITEMS --- */
        .list-group-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .list-group-item:hover {
            background-color: #f8fafc;
            border-color: var(--accent-color);
            transform: translateX(0);
        }

        /* --- DIMENSIONS LIST (Assessments) --- */
        .dim-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }

        .dim-item h6 {
            margin: 0;
        }

        .dim-pillar {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .dim-pillar a {
            color: #374151;
            text-decoration: none;
            padding: 6px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .dim-pillar a:hover {
            background: var(--hover-bg);
            color: var(--accent-color);
            text-decoration: none;
        }

        /* --- FORM CONTROLS --- */
        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 10px 12px;
            transition: all 0.2s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body>



    <!-- APP WRAPPER -->
    <div id="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand-logo"><img src="assets/img/tasheer-logo.png" alt="Tasheer" class="brand-img"
                    onerror="this.onerror=null; this.src='assets/img/tasheer-logo.svg'"><span>DMI Enterprise</span>
            </div>

            <nav id="sidebar-nav" class="d-flex flex-column flex-grow-1">
                <a href="#" class="nav-link active" onclick="renderDashboardExec()"><i class="bi bi-bar-chart-line"></i>
                    Analytics</a>
                <hr>
                <a href="#" class="nav-link" onclick="renderDashboard()"><i class="bi bi-layers"></i> Assessments</a>

                <div id="sidebar-dims"></div>


                <hr>
                <a href="#" id="nav-library" class="nav-link" onclick="renderLibrary()"><i class="bi bi-collection"></i>
                    Question Library</a>

                <hr>
                <a href="#" id="nav-config" class="nav-link" onclick="openConfig()"><i class="bi bi-gear"></i>
                    Configuration</a>
                                    <a href="#" id="nav-auditor" class="nav-link" onclick="renderAuditor()"><i
                        class="bi bi-pencil-square"></i> Audit Mode</a>
            </nav>

            <div class="user-profile text-dark small">

                <hr>

                <div class="fw-bold" id="sidebar-username">Admin</div>
                <div class="text-muted mb-2" id="sidebar-role">System Admin</div>
                <a href="#" onclick="handleLogout()" class="text-danger small text-decoration-none"><i
                        class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="print-header d-none d-print-block">
                <img src="assets/img/tasheer-logo.png" class="report-logo" alt="Tasheer"
                    onerror="this.onerror=null; this.src='assets/img/tasheer-logo.svg'">
            </div>

            <!-- Top Bar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0" id="main-breadcrumb">
                        <li class="breadcrumb-item"><img src="assets/img/tasheer-logo.png" class="small-logo me-2"
                                alt="Tasheer" onerror="this.onerror=null;this.src='assets/img/tasheer-logo.svg'">Home
                        </li>
                    </ol>
                </nav>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="exportAssessmentReport()"><i
                            class="bi bi-file-earmark-pdf"></i> Export Report</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportDataToFile()"><i
                            class="bi bi-download"></i> Export JSON</button>
                </div>
            </div>

            <!-- VIEW 1: EXECUTIVE DASHBOARD (Charts) -->
            <div id="view-dashboard-exec">
                <h2 class="fw-bold mb-4">Executive Overview</h2>

                <!-- Key Metrics -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-primary me-3"><i class="bi bi-activity"></i></div>
                            <div>
                                <div class="text-muted small">Total Score</div>
                                <div class="fs-3 fw-bold" id="exec-total-score">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-success me-3"><i class="bi bi-check-circle"></i></div>
                            <div>
                                <div class="text-muted small">Completion</div>
                                <div class="fs-3 fw-bold" id="exec-completion">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-warning me-3"><i class="bi bi-list-check"></i></div>
                            <div>
                                <div class="text-muted small">Questions</div>
                                <div class="fs-3 fw-bold" id="exec-total-q">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card d-flex align-items-center">
                            <div class="fs-1 text-danger me-3"><i class="bi bi-exclamation-triangle"></i></div>
                            <div>
                                <div class="text-muted small">Alerts</div>
                                <div class="fs-3 fw-bold">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="stat-card mb-4">
                            <h6 class="fw-bold mb-3">Maturity by Dimension</h6>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="stat-card">
                            <h6 class="fw-bold mb-3">Maturity Radar</h6>
                            <div class="chart-container">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Metrics by Dimension -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="fw-bold mb-0">ðŸ“Š Detailed Assessment Metrics</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Dimension</th>
                                        <th class="text-center">Total Questions</th>
                                        <th class="text-center">Answered</th>
                                        <th class="text-center">Completion %</th>
                                        <th class="text-center">Total Score</th>
                                        <th class="text-center">Avg Score</th>
                                    </tr>
                                </thead>
                                <tbody id="metrics-table-body">
                                    <!-- Populated by renderDashboardExec -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-muted small">
                            <strong id="total-questions-display">Total Questions Loaded: 0</strong> |
                            <span id="completion-display">Overall Completion: 0%</span>
                        </div>
                    </div>
                </div>

                <!-- Random Selection & Save to Data.js Section -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="fw-bold mb-0"><i class="bi bi-shuffle text-primary"></i> Random Selection & Data
                            Export</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Generate a random selection from all 180 questions and save to
                            Data.js file for automatic dashboard updates.</p>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Sample Size</label>
                                <select class="form-select" id="data-sample-size">
                                    <option value="30">30 Questions</option>
                                    <option value="50">50 Questions</option>
                                    <option value="90">90 Questions (50%)</option>
                                    <option value="120">120 Questions</option>
                                    <option value="150">150 Questions</option>
                                    <option value="180" selected>All 180 Questions</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Score Distribution</label>
                                <select class="form-select" id="data-distribution">
                                    <option value="random" selected>Random (0-5)</option>
                                    <option value="low">Low Range (0-2)</option>
                                    <option value="medium">Medium Range (2-3)</option>
                                    <option value="high">High Range (3-5)</option>
                                    <option value="realistic">Realistic Mix</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Action</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary flex-fill" onclick="generateRandomSelection()">
                                        <i class="bi bi-shuffle"></i> Generate Random
                                    </button>
                                    <button class="btn btn-success flex-fill" onclick="saveQuizResult()"
                                        id="btn-save-data" disabled>
                                        <i class="bi bi-save"></i> Save QuizResult.js
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Selection Summary -->
                        <div id="selection-summary" class="alert alert-info small mb-0 d-none">
                            <div class="row">
                                <div class="col-md-3"><strong>Questions Selected:</strong> <span
                                        id="sum-questions">0</span></div>
                                <div class="col-md-3"><strong>Total Score:</strong> <span id="sum-score">0</span></div>
                                <div class="col-md-3"><strong>Avg Score:</strong> <span id="sum-avg">0.00</span></div>
                                <div class="col-md-3"><strong>Status:</strong> <span id="sum-status"
                                        class="badge bg-warning">Not Saved</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: ASSESSMENT NAVIGATION (Drilldown) -->
            <div id="view-dashboard" class="hidden">
                <h2 class="fw-bold mb-4">Assessments</h2>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Dimension</label>
                        <select class="form-select" id="assess-dim" onchange="loadAssessmentPillars()">
                            <option value="">Select a Dimension...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Focus Area (Pillar)</label>
                        <select class="form-select" id="assess-pillar" onchange="loadAssessmentGroups()">
                            <option value="">Select a Focus Area...</option>
                        </select>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card">
                            <h5 class="fw-bold mb-3" id="assess-group-title">Select a Group</h5>
                            <div id="questions-container"></div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="saveCurrentAssessment()"><i
                                        class="bi bi-check-lg"></i> Save Progress</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="stat-card sticky-top" style="top: 20px; z-index: 10;">
                            <h6 class="fw-bold mb-3">Assessment Groups</h6>
                            <div id="assess-groups-list" class="d-flex flex-column gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: QUESTION LIBRARY (Flat Table) -->
            <div id="view-library" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Question Library</h2>
                    <div>
                        <input type="text" class="form-control d-inline-block w-auto me-2"
                            placeholder="Search questions..." id="lib-search" onkeyup="filterLibrary()">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQModal"><i
                                class="bi bi-plus-lg"></i> New</button>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-muted small">Total Questions</div>
                            <div class="fs-4 fw-bold" id="lib-total-questions">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-muted small">Dimensions</div>
                            <div class="fs-4 fw-bold" id="lib-total-dimensions">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-muted small">Focus Areas</div>
                            <div class="fs-4 fw-bold" id="lib-total-pillars">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="text-muted small">Assessment Groups</div>
                            <div class="fs-4 fw-bold" id="lib-total-groups">0</div>
                        </div>
                    </div>
                </div>

                <div class="custom-table-container">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Dimension</th>
                                <th>Question Text</th>
                                <th>Group</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="library-tbody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW 4: LIST (Pillars/Groups) -->
            <div id="view-list" class="hidden">
                <h3 class="fw-bold mb-3" id="list-title">Selection</h3>
                <div class="custom-table-container" id="list-container"></div>
            </div>

            <!-- VIEW 5: ASSESSMENT (Questions) -->
            <div id="view-assessment" class="hidden">
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <h2 class="fw-bold">Assessment</h2>
                        <p class="text-muted" id="assessment-subtitle">Group Name</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <button class="btn btn-primary px-4" onclick="saveCurrentAssessment()">Save Progress</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8" id="questions-container"></div>
                    <div class="col-lg-4">
                        <div class="stat-card sticky-top" style="top: 20px; z-index: 10;">
                            <h6 class="fw-bold mb-3">Session Progress</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Answered</span>
                                <span class="fw-bold" id="summary-answered">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div id="summary-bar" class="progress-bar bg-primary" style="width: 0%"></div>
                            </div>
                            <div class="alert alert-light small border">
                                <strong>Tip:</strong> Click levels to select. Selecting a low score may prompt for
                                comments.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: AUDITOR MODE (Add Question) -->
            <div id="view-auditor" class="hidden">
                <h2 class="fw-bold mb-4">Auditor Dashboard</h2>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Select a group to <strong>edit existing questions</strong> or
                    <strong>add new ones</strong>.
                </div>
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">Question Management</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small">Dimension</label>
                            <select class="form-select" id="audit-dim" onchange="loadAuditPillars()">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Focus Area</label>
                            <select class="form-select" id="audit-pillar" onchange="loadAuditGroups()">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Assessment Group</label>
                            <select class="form-select" id="audit-group" onchange="loadAuditQuestions()">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Existing Questions List -->
                    <div id="audit-questions-list" class="mt-3 hidden">
                        <div class="mb-3">
                            <label class="form-label small">Existing Questions in Group</label>
                            <div id="questions-buttons" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control" id="audit-q-text" rows="2"
                            placeholder="Question Text or select existing..."></textarea>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="text" id="audit-l0" class="form-control form-control-sm"
                                placeholder="L0: None"></div>
                        <div class="col-6"><input type="text" id="audit-l1" class="form-control form-control-sm"
                                placeholder="L1: Initial"></div>
                        <div class="col-6"><input type="text" id="audit-l2" class="form-control form-control-sm"
                                placeholder="L2: Dev"></div>
                        <div class="col-6"><input type="text" id="audit-l3" class="form-control form-control-sm"
                                placeholder="L3: Def"></div>
                        <div class="col-6"><input type="text" id="audit-l4" class="form-control form-control-sm"
                                placeholder="L4: Mng"></div>
                        <div class="col-6"><input type="text" id="audit-l5" class="form-control form-control-sm"
                                placeholder="L5: Opt"></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-primary w-100" id="audit-save-btn"
                                onclick="submitAuditorForm()">Add Question</button></div>
                        <div class="col-6"><button class="btn btn-outline-secondary w-100" id="audit-clear-btn"
                                onclick="clearAuditForm()">Clear</button></div>
                    </div>
                </div>

                <!-- Random Selection Analytics Button -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="bi bi-shuffle"></i> Random Selection Analytics</h6>
                        <p class="text-muted small mb-3">Generate a random sample of questions and view comprehensive
                            analytics and reports.</p>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label small">Sample Size</label>
                                <select class="form-select" id="random-sample-size">
                                    <option value="10">10 Questions</option>
                                    <option value="20">20 Questions</option>
                                    <option value="30" selected>30 Questions</option>
                                    <option value="50">50 Questions</option>
                                    <option value="100">100 Questions</option>
                                    <option value="all">All Questions (360)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Score Range</label>
                                <select class="form-select" id="random-score-filter">
                                    <option value="all" selected>All Scores (0-5)</option>
                                    <option value="low">Low (0-2)</option>
                                    <option value="medium">Medium (3)</option>
                                    <option value="high">High (4-5)</option>
                                    <option value="answered">Only Answered</option>
                                    <option value="unanswered">Only Unanswered</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-success w-100" onclick="generateRandomReport()">
                                    <i class="bi bi-bar-chart-fill"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-Answer & Generate Report -->
                <div class="card border-0 shadow-sm mt-4 bg-light">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="bi bi-lightning-charge-fill text-warning"></i> Auto-Answer &
                            Generate Report</h6>
                        <p class="text-muted small mb-3">Automatically generate random answers for 180 questions and
                            create a comprehensive final report with analytics.</p>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label small">Number of Questions</label>
                                <select class="form-select" id="auto-answer-count">
                                    <option value="50">50 Questions</option>
                                    <option value="100">100 Questions</option>
                                    <option value="180" selected>180 Questions (Half)</option>
                                    <option value="270">270 Questions (75%)</option>
                                    <option value="360">All 360 Questions</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Answer Distribution</label>
                                <select class="form-select" id="auto-answer-distribution">
                                    <option value="random" selected>Random (0-5)</option>
                                    <option value="low">Low Range (0-2)</option>
                                    <option value="medium">Medium Range (2-3)</option>
                                    <option value="high">High Range (3-5)</option>
                                    <option value="realistic">Realistic Mix</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-warning w-100" onclick="autoAnswerAndReport()">
                                    <i class="bi bi-lightning-fill"></i> Auto-Answer & Report
                                </button>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> This will randomly
                            answer the selected number of questions and generate a final report. Existing answers may be
                            overwritten.
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Question Modal (For Library) -->
    <div class="modal fade" id="addQModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Question</h5>
                </div>
                <div class="modal-body">
                    <form id="lib-form">
                        <div class="mb-3">
                            <label class="form-label">Dimension</label>
                            <select class="form-select" id="lib-dim" onchange="loadLibPillars()"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Focus Area (Pillar)</label>
                            <select class="form-select" id="lib-pillar" onchange="loadLibGroups()"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assessment Group</label>
                            <select class="form-select" id="lib-group"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question</label>
                            <textarea class="form-control" id="lib-q-text" rows="3"
                                placeholder="Enter your question..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitLibForm()">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Load Quiz Files -->
    <script src="assets/quizzes/quiz_1_external_applications.js"></script>
    <script src="assets/quizzes/quiz_2_internal_applications.js"></script>
    <script src="assets/quizzes/quiz_3_security_compliance.js"></script>
    <script src="assets/quizzes/quiz_4_monitoring_controls.js"></script>
    <script src="assets/quizzes/quiz_5_innovation_edge.js"></script>

    <!-- Load Generated Responses -->
    <script src="generated_responses.js"></script>
    <!-- Load Quiz Result Data (for dashboard auto-update) -->
    <script src="assets/quizzes/QuizResult.js"
        onerror="console.log('QuizResult.js not found - using default data')"></script>

    <script>
        // --- 1. DATA & CONFIG ---
        const standardGroups = [
            { id: 'strategy', name: 'Strategy' },
            { id: 'capability', name: 'Capability' },
            { id: 'operation', name: 'Operation' },
            { id: 'services', name: 'Services' },
            { id: 'technology', name: 'Technology' },
            { id: 'beneficiary', name: 'Beneficiary' }
        ];

        const seedData = [
            {
                id: 'ext_app', name: '1- External Application ', points: 40, pillars: [
                    { id: 'tasheer_branch_apps', name: '1.1 - Tasheer branch applications', groups: JSON.parse(JSON.stringify(standardGroups)) },
                    { id: 'national_integrations', name: '1.2 - National platform integrations', groups: JSON.parse(JSON.stringify(standardGroups)) }
                ]
            },
            {
                id: 'int_app', name: '2- Internal Applications ', points: 40, pillars: [
                    { id: 'sap_erp', name: '2.1 - SAP ERP and enterprise modules', groups: JSON.parse(JSON.stringify(standardGroups)) },
                    { id: 'itsm_onclick', name: '2.2 - ITSM services through OnClick', groups: JSON.parse(JSON.stringify(standardGroups)) }
                ]
            },
            {
                id: 'sec', name: '3- Security & Compliance ', points: 20, pillars: [
                    { id: 'regulatory_alignment', name: '3.1 - Regulatory alignment', groups: JSON.parse(JSON.stringify(standardGroups)) },
                    { id: 'continuous_monitoring', name: '3.2 - Continuous monitoring', groups: JSON.parse(JSON.stringify(standardGroups)) }
                ]
            },
            {
                id: 'mon', name: '4- Monitoring & Controls ', points: 40, pillars: [
                    { id: 'dev_ops_coverage', name: '4.1 - Development to operations coverage', groups: JSON.parse(JSON.stringify(standardGroups)) },
                    { id: 'system_observability', name: '4.2 - System observability and Infrastructure usage', groups: JSON.parse(JSON.stringify(standardGroups)) }
                ]
            },
            {
                id: 'inn', name: '5- Innovation & Edge Tech ', points: 10, pillars: [
                    { id: 'emerging_tech', name: '5.1 - Emerging technologies', groups: JSON.parse(JSON.stringify(standardGroups)) },
                    { id: 'edge_computing', name: '5.2 - Edge computing', groups: JSON.parse(JSON.stringify(standardGroups)) }
                ]
            }
        ];

        let appData = [];
        let userResponses = {};
        let currentUser = null;
        let currentPath = { dimIdx: null, pillarIdx: null, groupIdx: null };
        let charts = {};

        // --- 2. INITIALIZATION ---
        async function loadData() {
            const stored = localStorage.getItem('tasheer_dmi_ent_v3');
            if (stored) return JSON.parse(stored);
            try {
                const response = await fetch('./tasheer_data.json');
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('tasheer_dmi_ent_v3', JSON.stringify(data));
                    return data;
                }
            } catch (e) { }
            return seedData;
        }

        async function initApp() {
            appData = await loadData();
            seedStructureOnly();
            mergeQuizData();
            saveData();

            const storedResponses = localStorage.getItem('tasheer_resp_ent_v3');
            if (storedResponses) userResponses = JSON.parse(storedResponses);

            let userSession = sessionStorage.getItem('tasheer_user_ent_v3');
            if (userSession) {
                currentUser = JSON.parse(userSession);
            } else {
                currentUser = { username: 'Admin', role: 'admin' };
                sessionStorage.setItem('tasheer_user_ent_v3', JSON.stringify(currentUser));
            }
            showApp();
        }

        function mergeQuizData() {
            // Array of quiz objects loaded from JS files
            const allQuizzes = [
                quiz_1_external_applications,
                quiz_2_internal_applications,
                quiz_3_security_compliance,
                quiz_4_monitoring_controls,
                quiz_5_innovation_edge
            ];

            allQuizzes.forEach(quiz => {
                // Find matching dimension in appData
                const dimIndex = appData.findIndex(d => d.id === quiz.id);
                if (dimIndex !== -1) {
                    quiz.pillars.forEach((quizPillar, pIdx) => {
                        if (appData[dimIndex].pillars[pIdx]) {
                            quizPillar.groups.forEach((quizGroup, gIdx) => {
                                if (appData[dimIndex].pillars[pIdx].groups[gIdx]) {
                                    // Merge questions from quiz file
                                    appData[dimIndex].pillars[pIdx].groups[gIdx].questions = quizGroup.questions;
                                }
                            });
                        }
                    });
                }
            });
        }

        function seedStructureOnly() {
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        if (!group.questions) group.questions = [];
                    });
                });
            });
        }

        // --- 3. CORE UI LOGIC ---
        function saveData() { localStorage.setItem('tasheer_dmi_ent_v3', JSON.stringify(appData)); }
        function saveResponses() { localStorage.setItem('tasheer_resp_ent_v3', JSON.stringify(userResponses)); }

        // Get total question count across all dimensions
        function getTotalQuestionCount() {
            let count = 0;
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        count += group.questions.length;
                    });
                });
            });
            return count;
        }

        // Get all questions as flat array for search/reports
        function getAllQuestions() {
            const allQuestions = [];
            appData.forEach((dim, dIdx) => {
                dim.pillars.forEach((pillar, pIdx) => {
                    pillar.groups.forEach((group, gIdx) => {
                        group.questions.forEach(q => {
                            allQuestions.push({
                                ...q,
                                dimension: dim.name,
                                dimensionId: dim.id,
                                pillar: pillar.name,
                                pillarId: pillar.id,
                                group: group.name,
                                groupId: group.id
                            });
                        });
                    });
                });
            });
            return allQuestions;
        }

        // Get answered questions count
        function getAnsweredCount() {
            loadGeneratedResponses();
            let count = 0;
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions.forEach(q => {
                            if (userResponses[q.id] !== undefined) count++;
                        });
                    });
                });
            });
            return count;
        }

        // Calculate completion percentage
        function getCompletionPercentage() {
            const total = getTotalQuestionCount();
            if (total === 0) return 0;
            return Math.round((getAnsweredCount() / total) * 100);
        }

        // Calculate total score across all questions
        function getTotalScore() {
            loadGeneratedResponses();
            let totalScore = 0;
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions.forEach(q => {
                            if (userResponses[q.id] !== undefined) {
                                totalScore += parseInt(userResponses[q.id]);
                            }
                        });
                    });
                });
            });
            return totalScore;
        }

        // Export responses to generated_responses.js file
        function exportResponsesToFile(responses, metadata) {
            const fileContent = `// Auto-generated responses from DMI Assessment System
// This file is automatically updated when using the Auto-Answer & Generate Report feature
// Last Updated: ${new Date().toLocaleString()}

const generatedResponses = {
    metadata: {
        generated: "${new Date().toISOString()}",
        questionsAnswered: ${metadata.questionsAnswered},
        distribution: "${metadata.distribution}",
        totalScore: ${metadata.totalScore},
        averageScore: ${metadata.averageScore},
        completionPercent: ${metadata.completionPercent}
    },
    responses: ${JSON.stringify(responses, null, 4)}
};

// Export for use in the application
if (typeof module !== 'undefined' && module.exports) {
    module.exports = generatedResponses;
}
`;

            // Create a blob and download link to save the file
            const blob = new Blob([fileContent], { type: 'text/javascript' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'generated_responses.js';
            a.click();

            console.log('Exported responses to generated_responses.js file');

            // Also update the in-memory generatedResponses object if it exists
            if (typeof generatedResponses !== 'undefined') {
                generatedResponses.metadata = metadata;
                generatedResponses.responses = responses;
                console.log('Updated in-memory generatedResponses object');
            }

            return fileContent;
        }

        // Load responses from generatedResponses if available
        function loadGeneratedResponses() {
            if (typeof generatedResponses !== 'undefined' &&
                generatedResponses.responses &&
                Object.keys(generatedResponses.responses).length > 0) {
                // Merge generated responses with existing responses
                Object.assign(userResponses, generatedResponses.responses);
                console.log('Loaded generated responses:', Object.keys(generatedResponses.responses).length, 'answers');
                return true;
            }
            return false;
        }

        // Get dimension-specific metrics
        function getDimensionMetrics() {
            // Load generated responses if available
            loadGeneratedResponses();

            return appData.map(dim => {
                let dimTotal = 0;
                let dimAnswered = 0;
                let dimQCount = 0;

                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions.forEach(q => {
                            dimQCount++;
                            if (userResponses[q.id] !== undefined) {
                                dimAnswered++;
                                dimTotal += parseInt(userResponses[q.id]);
                            }
                        });
                    });
                });

                return {
                    name: dim.name,
                    id: dim.id,
                    points: dim.points,
                    totalQuestions: dimQCount,
                    answeredQuestions: dimAnswered,
                    totalScore: dimTotal,
                    avgScore: dimQCount > 0 ? (dimTotal / dimQCount).toFixed(2) : 0,
                    completion: dimQCount > 0 ? Math.round((dimAnswered / dimQCount) * 100) : 0
                };
            });
        }



        function showApp() {
            const loginContainer = document.getElementById('login-container');
            if (loginContainer) {
                loginContainer.style.opacity = '0';
                setTimeout(() => { loginContainer.classList.add('hidden'); }, 500);
            }
            const appWrap = document.getElementById('app-wrapper'); if (appWrap) appWrap.classList.add('active');
            const sbUser = document.getElementById('sidebar-username'); if (sbUser && currentUser) sbUser.innerText = currentUser.username;
            if (currentUser && currentUser.role !== 'admin') {
                const navLibrary = document.getElementById('nav-library'); if (navLibrary) navLibrary.classList.add('hidden');
                const navAuditor = document.getElementById('nav-auditor'); if (navAuditor) navAuditor.classList.add('hidden');
            }
            renderSidebar();
            renderDashboardExec();

            // Wire up modal initialization
            const addQModal = document.getElementById('addQModal');
            if (addQModal) {
                addQModal.addEventListener('show.bs.modal', initLibraryModal);
            }
        }

        function handleLogout() { sessionStorage.removeItem('tasheer_user_ent_v3'); location.reload(); }

        const fileInputEl = document.getElementById('file-input');
        if (fileInputEl) {
            fileInputEl.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            appData = json; seedStructureOnly(); saveData();
                            alert("Imported!");
                        }
                    } catch (err) { alert("Invalid JSON"); }
                };
                reader.readAsText(file);
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('[id^="view-dashboard"], [id^="view-list"], [id^="view-assessment"], [id^="view-library"], [id^="view-auditor"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function setActiveNav(id) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            if (id) document.getElementById(id).classList.add('active');
        }

        // --- SIDEBAR RENDERING ---
        const dimMeta = {
            'ext_app': { icon: 'bi-cloud', color: 'text-primary' },
            'int_app': { icon: 'bi-stack', color: 'text-success' },
            'sec': { icon: 'bi-shield-lock', color: 'text-danger' },
            'mon': { icon: 'bi-speedometer2', color: 'text-warning' },
            'inn': { icon: 'bi-lightning-charge', color: 'text-info' }
        };

        function renderSidebar() {
            const container = document.getElementById('sidebar-dims');
            if (!container) return;
            container.innerHTML = '';
            appData.forEach((dim, dIdx) => {
                const meta = dimMeta[dim.id] || {};
                const iconClass = meta.icon ? `bi ${meta.icon}` : 'bi bi-shield-fill';
                const colorClass = meta.color || '';

                const section = document.createElement('div');
                section.className = 'mb-2';
                section.innerHTML = `
                    <button class="section-toggle" data-didx="${dIdx}" onclick="toggleDim(this)">
                        <span><i class="dim-icon ${iconClass} ${colorClass}"></i> <strong>${dim.name}</strong></span>
                        <i class="chev bi bi-chevron-down"></i>
                    </button> 
                    <div class="sub-links" id="sub-dim-${dIdx}">${dim.pillars.map((p, i) => `<a href="#" class="nav-link sub-link pillar-link" onclick="renderGroups(${dIdx}, ${i});return false;"><i class="bi bi-dot"></i> ${p.name}</a>`).join('')}</div>
                `;
                container.appendChild(section);
            });
        }

        function toggleDim(btn) {
            const dIdx = btn.getAttribute('data-didx');
            const sub = document.getElementById(`sub-dim-${dIdx}`);
            if (!sub) return;
            const open = sub.classList.toggle('open');
            btn.classList.toggle('open', open);
            if (open) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- 4. EXECUTIVE DASHBOARD (Analytics) ---
        function renderDashboardExec() {
            switchView('view-dashboard-exec');
            setActiveNav();

            // Load generated responses if available
            loadGeneratedResponses();

            // Get detailed metrics using helper function
            const metrics = getDimensionMetrics();
            let totalQ = 0;
            let answeredQ = 0;
            let totalScore = 0;
            let dimScores = [];
            let dimLabels = [];
            let metricsTableHtml = '';

            metrics.forEach(dim => {
                totalQ += dim.totalQuestions;
                answeredQ += dim.answeredQuestions;
                totalScore += dim.totalScore;

                dimScores.push(dim.totalScore);
                dimLabels.push(dim.name);

                // Build metrics table row
                const completion = dim.totalQuestions > 0 ? Math.round((dim.answeredQuestions / dim.totalQuestions) * 100) : 0;
                const avgScore = dim.answeredQuestions > 0 ? (dim.avgScore).toFixed(2) : '0.00';

                metricsTableHtml += `
                    <tr>
                        <td><strong>${dim.name}</strong></td>
                        <td class="text-center">${dim.totalQuestions}</td>
                        <td class="text-center">${dim.answeredQuestions}</td>
                        <td class="text-center"><span class="badge bg-${completion >= 75 ? 'success' : completion >= 50 ? 'info' : 'warning'}">${completion}%</span></td>
                        <td class="text-center"><strong>${Math.round(dim.totalScore)}</strong></td>
                        <td class="text-center">${avgScore}</td>
                    </tr>
                `;
            });

            // Update main stats
            document.getElementById('exec-total-score').innerText = Math.round(totalScore);
            document.getElementById('exec-completion').innerText = Math.round((answeredQ / totalQ) * 100) + '%';
            document.getElementById('exec-total-q').innerText = totalQ;

            // Update metrics table
            const tableBody = document.getElementById('metrics-table-body');
            if (tableBody) {
                tableBody.innerHTML = metricsTableHtml;
            }

            // Update total display
            const totalDisplay = document.getElementById('total-questions-display');
            if (totalDisplay) {
                totalDisplay.innerText = `Total Questions Loaded: ${totalQ}`;
            }

            const completionDisplay = document.getElementById('completion-display');
            if (completionDisplay) {
                completionDisplay.innerText = `Overall Completion: ${Math.round((answeredQ / totalQ) * 100)}%`;
            }

            renderCharts(dimScores, dimLabels);
        }

        function renderCharts(data, labels) {
            const barCtx = document.getElementById('barChart').getContext('2d');
            const radarCtx = document.getElementById('radarChart').getContext('2d');

            if (charts.bar) charts.bar.destroy();
            if (charts.radar) charts.radar.destroy();

            charts.bar = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Score',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            grid: { color: '#e5e7eb' },
                            ticks: { color: '#6b7280' }
                        },
                        x: {
                            grid: { color: '#e5e7eb' },
                            ticks: { color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#6b7280' } }
                    }
                }
            });

            charts.radar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Maturity',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: { color: '#e5e7eb' },
                            angleLines: { color: '#e5e7eb' },
                            pointLabels: { color: '#6b7280' },
                            ticks: { backdropColor: 'transparent', color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#6b7280' } }
                    }
                }
            });
        }

        // --- 5. QUESTION LIBRARY ---
        function renderLibrary() {
            switchView('view-library');
            setActiveNav('nav-library');
            filterLibrary();
        }

        function filterLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const tbody = document.getElementById('library-tbody');
            tbody.innerHTML = '';

            // Calculate summary statistics
            let totalQCount = 0;
            let dimSet = new Set();
            let pillarSet = new Set();
            let groupSet = new Set();

            appData.forEach((dim, dIdx) => {
                dim.pillars.forEach((pillar, pIdx) => {
                    pillar.groups.forEach((group, gIdx) => {
                        group.questions.forEach((q, qIdx) => {
                            totalQCount++;
                            dimSet.add(dim.name);
                            pillarSet.add(pillar.name);
                            groupSet.add(group.name);

                            if (q.text.toLowerCase().includes(term)) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td class="small text-muted">${q.id}</td>
                                    <td>${dim.name}</td>
                                    <td>${q.text}</td>
                                    <td><span class="badge bg-light text-dark border">${group.name}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion('${q.id}')"><i class="bi bi-trash"></i></button>
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            }
                        });
                    });
                });
            });

            // Update summary statistics
            document.getElementById('lib-total-questions').innerText = totalQCount;
            document.getElementById('lib-total-dimensions').innerText = dimSet.size;
            document.getElementById('lib-total-pillars').innerText = pillarSet.size;
            document.getElementById('lib-total-groups').innerText = groupSet.size;

            if (tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No questions found.</td></tr>';
        }

        function deleteQuestion(id) {
            if (!confirm("Delete this question?")) return;
            appData.forEach(dim => {
                dim.pillars.forEach(pillar => {
                    pillar.groups.forEach(group => {
                        group.questions = group.questions.filter(q => q.id !== id);
                    });
                });
            });
            saveData();
            filterLibrary();
            showToast("Question deleted.");
        }

        function loadLibPillars() {
            const dIdx = document.getElementById('lib-dim').value;
            const pSelect = document.getElementById('lib-pillar');
            const gSelect = document.getElementById('lib-group');
            pSelect.innerHTML = '<option value="">Select a Pillar...</option>';
            gSelect.innerHTML = '<option value="">Select a Group...</option>';
            if (dIdx !== "") {
                appData[dIdx].pillars.forEach((p, i) => pSelect.innerHTML += `<option value="${i}">${p.name}</option>`);
            }
        }
        function loadLibGroups() {
            const dIdx = document.getElementById('lib-dim').value;
            const pIdx = document.getElementById('lib-pillar').value;
            const gSelect = document.getElementById('lib-group');
            gSelect.innerHTML = '<option value="">Select a Group...</option>';
            if (dIdx !== "" && pIdx !== "") {
                if (appData[dIdx] && appData[dIdx].pillars[pIdx]) {
                    appData[dIdx].pillars[pIdx].groups.forEach((g, i) => gSelect.innerHTML += `<option value="${i}">${g.name}</option>`);
                }
            }
        }
        function initLibraryModal() {
            const dSelect = document.getElementById('lib-dim');
            const pSelect = document.getElementById('lib-pillar');
            const gSelect = document.getElementById('lib-group');
            dSelect.innerHTML = '<option value="">Select a Dimension...</option>';
            pSelect.innerHTML = '<option value="">Select a Pillar...</option>';
            gSelect.innerHTML = '<option value="">Select a Group...</option>';
            document.getElementById('lib-q-text').value = '';
            appData.forEach((d, i) => dSelect.innerHTML += `<option value="${i}">${d.name}</option>`);
        }
        function submitLibForm() {
            const dIdx = document.getElementById('lib-dim').value;
            const pIdx = document.getElementById('lib-pillar').value;
            const gIdx = document.getElementById('lib-group').value;
            const text = document.getElementById('lib-q-text').value;

            if (dIdx === "" || pIdx === "" || gIdx === "" || !text) return alert("Fill all fields");

            const newQ = {
                id: Date.now().toString(),
                text: text,
                levels: ["Non-Existent", "Initial", "Developing", "Defined", "Managed", "Optimized"]
            };
            appData[dIdx].pillars[pIdx].groups[gIdx].questions.push(newQ);
            saveData();

            const modalEl = document.getElementById('addQModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            filterLibrary();
            showToast("Added to Library");
        }

        // --- 6. ASSESSMENT NAVIGATION ---
        function renderDashboard() {
            switchView('view-dashboard');
            setActiveNav();
            const dimSelect = document.getElementById('assess-dim');
            dimSelect.innerHTML = '<option value="">Select a Dimension...</option>';
            appData.forEach((d, i) => { dimSelect.innerHTML += `<option value="${i}">${d.name}</option>`; });
            document.getElementById('assess-pillar').innerHTML = '<option value="">Select a Focus Area...</option>';
            document.getElementById('assess-groups-list').innerHTML = '';
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('assess-group-title').innerText = 'Select a Group';
        }

        function loadAssessmentPillars() {
            const dIdx = document.getElementById('assess-dim').value;
            const pSelect = document.getElementById('assess-pillar');
            const gSelect = document.getElementById('assess-groups-list');
            pSelect.innerHTML = '<option value="">Select a Focus Area...</option>';
            gSelect.innerHTML = '';
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('assess-group-title').innerText = 'Select a Group';

            if (dIdx !== "") {
                appData[dIdx].pillars.forEach((p, i) => pSelect.innerHTML += `<option value="${i}">${p.name}</option>`);
            }
        }

        function loadAssessmentGroups() {
            const dIdx = document.getElementById('assess-dim').value;
            const pIdx = document.getElementById('assess-pillar').value;
            const gSelect = document.getElementById('assess-groups-list');
            gSelect.innerHTML = '';
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('assess-group-title').innerText = 'Select a Group';

            if (dIdx === "" || pIdx === "") return;

            if (appData[dIdx] && appData[dIdx].pillars[pIdx]) {
                currentPath.dimIdx = dIdx;
                currentPath.pillarIdx = pIdx;
                appData[dIdx].pillars[pIdx].groups.forEach((group, gIdx) => {
                    let qCount = group.questions.length;
                    let answered = group.questions.filter(q => userResponses[q.id] !== undefined).length;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-outline-primary text-start position-relative';
                    btn.innerHTML = `
                        <div class="fw-bold">${group.name}</div>
                        <small class="text-muted">${answered}/${qCount} answered</small>
                    `;
                    btn.onclick = () => loadAssessmentQuestions(dIdx, pIdx, gIdx);
                    gSelect.appendChild(btn);
                });
            }
        }

        function loadAssessmentQuestions(dimIdx, pillarIdx, groupIdx) {
            currentPath.groupIdx = groupIdx;
            const group = appData[dimIdx].pillars[pillarIdx].groups[groupIdx];
            document.getElementById('assess-group-title').innerText = `${group.name}`;
            renderQuestions(dimIdx, pillarIdx, groupIdx);
        }

        function renderPillars(dimIdx) {
            currentPath.dimIdx = dimIdx;
            switchView('view-list');
            const dim = appData[dimIdx];
            document.getElementById('list-title').innerText = `${dim.name} : Key Focus Areas`;
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            dim.pillars.forEach((pillar, pIdx) => {
                container.innerHTML += `<div class="list-group-item list-item p-3" onclick="renderGroups(${dimIdx}, ${pIdx})"><h6 class="fw-bold mb-0">${pillar.name}</h6><small class="text-muted">6 Groups</small></div>`;
            });
        }

        function renderGroups(dimIdx, pillarIdx) {
            currentPath.pillarIdx = pillarIdx;
            switchView('view-list');
            const pillar = appData[dimIdx].pillars[pillarIdx];
            document.getElementById('list-title').innerText = `${pillar.name} : Assessment Groups`;
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            pillar.groups.forEach((group, gIdx) => {
                let qCount = group.questions.length;
                let answered = group.questions.filter(q => userResponses[q.id] !== undefined).length;
                container.innerHTML += `
                    <div class="list-group-item list-item p-3" onclick="renderQuestions(${dimIdx}, ${pillarIdx}, ${gIdx})">
                        <div>
                            <h6 class="fw-bold mb-1">${group.name} <span class="badge bg-light text-dark ms-2">${answered}/${qCount}</span></h6>
                        </div>
                    </div>`;
            });
        }

        function renderQuestions(dimIdx, pillarIdx, groupIdx) {
            currentPath.groupIdx = groupIdx;
            const group = appData[dimIdx].pillars[pillarIdx].groups[groupIdx];

            // Update title if we're in the new dashboard view
            if (document.getElementById('assess-group-title')) {
                document.getElementById('assess-group-title').innerText = group.name;
            } else {
                // Fall back to old view
                switchView('view-assessment');
                document.getElementById('assessment-subtitle').innerText = `${appData[dimIdx].name} > ${appData[dimIdx].pillars[pillarIdx].name} > ${group.name}`;
            }

            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            if (!group.questions.length) {
                container.innerHTML = '<div class="alert alert-warning">No questions available.</div>';
                return;
            }

            let total = group.questions.length;
            let answered = 0;

            group.questions.forEach((q, qIdx) => {
                if (userResponses[q.id] !== undefined) answered++;
                const saved = userResponses[q.id];
                const card = document.createElement('div');
                card.className = 'stat-card mb-3 p-3';

                let buttons = '';
                q.levels.forEach((l, i) => {
                    const cl = saved == i ? 'selected level-' + i : '';
                    const label = (l.length > 12) ? l.substring(0, 12) + 'â€¦' : l;
                    buttons += `<div class="ms-btn ${cl}" onclick="setScore('${q.id}', ${i})"><strong>${i}</strong><small>${label}</small></div>`;
                });

                card.innerHTML = `
                    <h6 class="fw-bold mb-2">Q${qIdx + 1}: ${q.text}</h6>
                    <div class="maturity-scale">${buttons}</div>
                `;
                container.appendChild(card);
            });

            if (document.getElementById('summary-answered')) {
                document.getElementById('summary-answered').innerText = answered;
                document.getElementById('summary-bar').style.width = (answered / total * 100) + '%';
            }
        }

        function setScore(qId, level) {
            userResponses[qId] = level;
            saveResponses();
            renderQuestions(currentPath.dimIdx, currentPath.pillarIdx, currentPath.groupIdx);
        }

        function saveCurrentAssessment() {
            saveResponses();
            showToast("Progress Saved");
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = 'position-fixed bottom-0 end-0 p-3';
            div.style.zIndex = 2000;
            div.innerHTML = `<div class="toast show bg-dark text-white"><div class="toast-body">${msg}</div></div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // --- 7. AUDITOR MODE ---
        function renderAuditor() {
            switchView('view-auditor');
            setActiveNav('nav-auditor');
            const dimSelect = document.getElementById('audit-dim');
            dimSelect.innerHTML = '<option value="">Select...</option>';
            appData.forEach((d, i) => { dimSelect.innerHTML += `<option value="${i}">${d.name}</option>`; });
            clearAuditForm();
        }
        function loadAuditPillars() {
            const dIdx = document.getElementById('audit-dim').value;
            const pSelect = document.getElementById('audit-pillar');
            const gSelect = document.getElementById('audit-group');
            pSelect.innerHTML = '<option value="">Select...</option>';
            gSelect.innerHTML = '<option value="">Select...</option>';
            document.getElementById('audit-questions-list').classList.add('hidden');
            if (dIdx !== "") appData[dIdx].pillars.forEach((p, i) => pSelect.innerHTML += `<option value="${i}">${p.name}</option>`);
        }
        function loadAuditGroups() {
            const dIdx = document.getElementById('audit-dim').value;
            const pIdx = document.getElementById('audit-pillar').value;
            const gSelect = document.getElementById('audit-group');
            gSelect.innerHTML = '<option value="">Select...</option>';
            document.getElementById('audit-questions-list').classList.add('hidden');
            if (dIdx !== "" && pIdx !== "" && appData[dIdx] && appData[dIdx].pillars[pIdx]) {
                appData[dIdx].pillars[pIdx].groups.forEach((g, i) => gSelect.innerHTML += `<option value="${i}">${g.name}</option>`);
            }
        }
        function loadAuditQuestions() {
            const dIdx = document.getElementById('audit-dim').value;
            const pIdx = document.getElementById('audit-pillar').value;
            const gIdx = document.getElementById('audit-group').value;
            const questionsList = document.getElementById('audit-questions-list');
            const buttonsDiv = document.getElementById('questions-buttons');

            if (dIdx === "" || pIdx === "" || gIdx === "") {
                questionsList.classList.add('hidden');
                clearAuditForm();
                return;
            }

            const group = appData[dIdx].pillars[pIdx].groups[gIdx];
            if (!group.questions || group.questions.length === 0) {
                questionsList.classList.add('hidden');
                clearAuditForm();
                return;
            }

            buttonsDiv.innerHTML = '';
            group.questions.forEach((q, qIdx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-secondary btn-sm';
                btn.innerHTML = `Q${qIdx + 1}`;
                btn.onclick = () => loadQuestionIntoForm(dIdx, pIdx, gIdx, qIdx);
                buttonsDiv.appendChild(btn);
            });

            questionsList.classList.remove('hidden');
        }

        function loadQuestionIntoForm(dIdx, pIdx, gIdx, qIdx) {
            const q = appData[dIdx].pillars[pIdx].groups[gIdx].questions[qIdx];
            if (!q) return;

            document.getElementById('audit-q-text').value = q.text;
            document.getElementById('audit-l0').value = q.levels[0] || '';
            document.getElementById('audit-l1').value = q.levels[1] || '';
            document.getElementById('audit-l2').value = q.levels[2] || '';
            document.getElementById('audit-l3').value = q.levels[3] || '';
            document.getElementById('audit-l4').value = q.levels[4] || '';
            document.getElementById('audit-l5').value = q.levels[5] || '';

            // Store current edit context
            window.auditEditContext = { dIdx, pIdx, gIdx, qIdx };

            // Change button text
            document.getElementById('audit-save-btn').innerText = 'Update Question';
        }

        function clearAuditForm() {
            document.getElementById('audit-q-text').value = '';
            document.getElementById('audit-l0').value = '';
            document.getElementById('audit-l1').value = '';
            document.getElementById('audit-l2').value = '';
            document.getElementById('audit-l3').value = '';
            document.getElementById('audit-l4').value = '';
            document.getElementById('audit-l5').value = '';
            document.getElementById('audit-save-btn').innerText = 'Add Question';
            window.auditEditContext = null;
        }

        function submitAuditorForm() {
            const dIdx = document.getElementById('audit-dim').value;
            const pIdx = document.getElementById('audit-pillar').value;
            const gIdx = document.getElementById('audit-group').value;
            const text = document.getElementById('audit-q-text').value;

            if (dIdx === "" || pIdx === "" || gIdx === "" || !text) return alert("Fill fields");

            const levels = [
                document.getElementById('audit-l0').value || 'None',
                document.getElementById('audit-l1').value || 'Basic',
                document.getElementById('audit-l2').value || 'Dev',
                document.getElementById('audit-l3').value || 'Def',
                document.getElementById('audit-l4').value || 'Mng',
                document.getElementById('audit-l5').value || 'Opt'
            ];

            // Check if editing existing question
            if (window.auditEditContext) {
                const { dIdx: edIdx, pIdx: epIdx, gIdx: egIdx, qIdx: eqIdx } = window.auditEditContext;
                appData[edIdx].pillars[epIdx].groups[egIdx].questions[eqIdx].text = text;
                appData[edIdx].pillars[epIdx].groups[egIdx].questions[eqIdx].levels = levels;
                saveData();
                showToast("Question updated");
            } else {
                const newQ = {
                    id: Date.now().toString(),
                    text: text,
                    levels: levels
                };
                appData[dIdx].pillars[pIdx].groups[gIdx].questions.push(newQ);
                saveData();
                showToast("Question added");
            }

            clearAuditForm();
            loadAuditQuestions();
        }
        function exportDataToFile() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "tasheer_data.json";
            a.click();
        }

        function exportAssessmentReport() {
            const metrics = getDimensionMetrics();
            const allQuestions = getAllQuestions();
            const totalQuestions = getTotalQuestionCount();
            const answeredCount = getAnsweredCount();
            const completionPercent = getCompletionPercentage();
            const totalScore = getTotalScore();

            let reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DMI Assessment Report</title>
    <style>
        * { margin: 0; padding: 0; }
        body { font-family: 'Cairo', 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .report { background: white; padding: 40px; max-width: 1000px; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #1e40af; margin-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        h3 { color: #3b82f6; margin-top: 20px; margin-bottom: 10px; }
        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: #f0f4f8; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-card .label { font-size: 12px; color: #6b7280; }
        .metric-card .value { font-size: 24px; font-weight: bold; color: #1e40af; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        .progress-bar { display: inline-block; height: 20px; background: #3b82f6; border-radius: 4px; margin-right: 10px; }
        .timestamp { font-size: 12px; color: #9ca3af; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-complete { background: #dcfce7; color: #166534; }
        .status-partial { background: #fef3c7; color: #92400e; }
        .status-incomplete { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="report">
        <h1>ðŸ“Š DMI Assessment Report</h1>
        <p style="color: #6b7280; margin-bottom: 20px;">Generated: ${new Date().toLocaleString()}</p>

        <h2>Executive Summary</h2>
        <div class="summary">
            <div class="metric-card">
                <div class="label">Total Questions</div>
                <div class="value">${totalQuestions}</div>
            </div>
            <div class="metric-card">
                <div class="label">Questions Answered</div>
                <div class="value">${answeredCount}</div>
            </div>
            <div class="metric-card">
                <div class="label">Completion Rate</div>
                <div class="value">${completionPercent}%</div>
            </div>
            <div class="metric-card">
                <div class="label">Total Score</div>
                <div class="value">${Math.round(totalScore)}</div>
            </div>
        </div>

        <h2>Dimension-wise Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th>Dimension</th>
                    <th>Total Q</th>
                    <th>Answered</th>
                    <th>Completion</th>
                    <th>Total Score</th>
                    <th>Avg Score</th>
                </tr>
            </thead>
            <tbody>
`;

            metrics.forEach(dim => {
                const completion = dim.totalQuestions > 0 ? Math.round((dim.answeredQuestions / dim.totalQuestions) * 100) : 0;
                const statusClass = completion >= 75 ? 'status-complete' : completion >= 50 ? 'status-partial' : 'status-incomplete';
                const avgScore = dim.answeredQuestions > 0 ? (dim.avgScore).toFixed(2) : '0.00';

                reportHtml += `
                <tr>
                    <td><strong>${dim.name}</strong></td>
                    <td>${dim.totalQuestions}</td>
                    <td>${dim.answeredQuestions}</td>
                    <td><span class="status-badge ${statusClass}">${completion}%</span></td>
                    <td><strong>${Math.round(dim.totalScore)}</strong></td>
                    <td>${avgScore}</td>
                </tr>
`;
            });

            reportHtml += `
            </tbody>
        </table>

        <h2>Assessment Questions & Responses</h2>
        <p style="margin-bottom: 15px; color: #6b7280;">Total questions in assessment: ${allQuestions.length}</p>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dimension</th>
                    <th>Focus Area</th>
                    <th>Group</th>
                    <th>Question</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
`;

            allQuestions.forEach(q => {
                const score = userResponses[q.id] !== undefined ? userResponses[q.id] : '-';
                const scoreBg = score !== '-' && parseInt(score) >= 3 ? '#dcfce7' : score !== '-' ? '#fef3c7' : '#f3f4f6';

                reportHtml += `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.dimensionName}</td>
                    <td>${q.pillarName}</td>
                    <td>${q.groupName}</td>
                    <td>${q.text}</td>
                    <td style="background: ${scoreBg}; text-align: center; font-weight: 500;">${score}</td>
                </tr>
`;
            });

            reportHtml += `
            </tbody>
        </table>

        <div class="timestamp">
            <strong>Report Generated:</strong> ${new Date().toLocaleString()}<br>
            <strong>Assessment Tool:</strong> DMI Assessment System v1.0<br>
            <strong>Organization:</strong> SAUDI COMPANY FOR VISA AND TRAVEL SOLUTIONS
        </div>
    </div>
</body>
</html>
`;

            const blob = new Blob([reportHtml], { type: "text/html" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `DMI_Assessment_Report_${new Date().getTime()}.html`;
            a.click();
            showToast("Report exported successfully!");
        }

        function generateRandomReport() {
            const sampleSize = document.getElementById('random-sample-size').value;
            const scoreFilter = document.getElementById('random-score-filter').value;

            // Get all questions
            const allQuestions = getAllQuestions();

            // Filter based on score filter
            let filteredQuestions = allQuestions;
            if (scoreFilter !== 'all') {
                filteredQuestions = allQuestions.filter(q => {
                    const hasResponse = userResponses[q.id] !== undefined;
                    const score = hasResponse ? parseInt(userResponses[q.id]) : -1;

                    switch (scoreFilter) {
                        case 'low':
                            return hasResponse && score >= 0 && score <= 2;
                        case 'medium':
                            return hasResponse && score === 3;
                        case 'high':
                            return hasResponse && score >= 4 && score <= 5;
                        case 'answered':
                            return hasResponse;
                        case 'unanswered':
                            return !hasResponse;
                        default:
                            return true;
                    }
                });
            }

            // Randomly select questions
            let selectedQuestions = [];
            if (sampleSize === 'all') {
                selectedQuestions = filteredQuestions;
            } else {
                const numSamples = Math.min(parseInt(sampleSize), filteredQuestions.length);
                const shuffled = [...filteredQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions = shuffled.slice(0, numSamples);
            }

            if (selectedQuestions.length === 0) {
                showToast("No questions match the selected criteria.", "warning");
                return;
            }

            // Calculate metrics for selected questions
            let totalScore = 0;
            let answeredCount = 0;
            const dimensionStats = {};

            selectedQuestions.forEach(q => {
                if (userResponses[q.id] !== undefined) {
                    answeredCount++;
                    totalScore += parseInt(userResponses[q.id]);
                }

                if (!dimensionStats[q.dimensionName]) {
                    dimensionStats[q.dimensionName] = {
                        name: q.dimensionName,
                        total: 0,
                        answered: 0,
                        score: 0
                    };
                }
                dimensionStats[q.dimensionName].total++;
                if (userResponses[q.id] !== undefined) {
                    dimensionStats[q.dimensionName].answered++;
                    dimensionStats[q.dimensionName].score += parseInt(userResponses[q.id]);
                }
            });

            const completionPercent = Math.round((answeredCount / selectedQuestions.length) * 100);
            const avgScore = answeredCount > 0 ? (totalScore / answeredCount).toFixed(2) : '0.00';

            // Generate HTML report
            let reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DMI Random Sample Report</title>
    <style>
        * { margin: 0; padding: 0; }
        body { font-family: 'Cairo', 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .report { background: white; padding: 40px; max-width: 1200px; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #1e40af; margin-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: #f0f4f8; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-card .label { font-size: 12px; color: #6b7280; }
        .metric-card .value { font-size: 24px; font-weight: bold; color: #1e40af; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-complete { background: #dcfce7; color: #166534; }
        .status-partial { background: #fef3c7; color: #92400e; }
        .status-incomplete { background: #fee2e2; color: #991b1b; }
        .timestamp { font-size: 12px; color: #9ca3af; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
        .alert-box { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="report">
        <h1>ðŸŽ² DMI Random Sample Report</h1>
        <p style="color: #6b7280; margin-bottom: 20px;">Generated: ${new Date().toLocaleString()}</p>
        
        <div class="alert-box">
            <strong>ðŸ“Š Sample Details:</strong> ${selectedQuestions.length} questions selected from ${filteredQuestions.length} filtered questions (Total pool: ${allQuestions.length} questions)
            <br><strong>Filter Applied:</strong> ${scoreFilter === 'all' ? 'All Questions' : scoreFilter.charAt(0).toUpperCase() + scoreFilter.slice(1)}
        </div>

        <h2>Executive Summary</h2>
        <div class="summary">
            <div class="metric-card">
                <div class="label">Sample Size</div>
                <div class="value">${selectedQuestions.length}</div>
            </div>
            <div class="metric-card">
                <div class="label">Questions Answered</div>
                <div class="value">${answeredCount}</div>
            </div>
            <div class="metric-card">
                <div class="label">Completion Rate</div>
                <div class="value">${completionPercent}%</div>
            </div>
            <div class="metric-card">
                <div class="label">Total Score</div>
                <div class="value">${totalScore}</div>
            </div>
            <div class="metric-card">
                <div class="label">Avg Score</div>
                <div class="value">${avgScore}</div>
            </div>
        </div>

        <h2>Dimension-wise Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th>Dimension</th>
                    <th>Questions in Sample</th>
                    <th>Answered</th>
                    <th>Completion</th>
                    <th>Total Score</th>
                    <th>Avg Score</th>
                </tr>
            </thead>
            <tbody>
`;

            Object.values(dimensionStats).forEach(dim => {
                const completion = dim.total > 0 ? Math.round((dim.answered / dim.total) * 100) : 0;
                const statusClass = completion >= 75 ? 'status-complete' : completion >= 50 ? 'status-partial' : 'status-incomplete';
                const dimAvgScore = dim.answered > 0 ? (dim.score / dim.answered).toFixed(2) : '0.00';

                reportHtml += `
                <tr>
                    <td><strong>${dim.name}</strong></td>
                    <td>${dim.total}</td>
                    <td>${dim.answered}</td>
                    <td><span class="status-badge ${statusClass}">${completion}%</span></td>
                    <td><strong>${dim.score}</strong></td>
                    <td>${dimAvgScore}</td>
                </tr>
`;
            });

            reportHtml += `
            </tbody>
        </table>

        <h2>Selected Questions & Responses</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Dimension</th>
                    <th>Focus Area</th>
                    <th>Group</th>
                    <th>Question</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
`;

            selectedQuestions.forEach(q => {
                const score = userResponses[q.id] !== undefined ? userResponses[q.id] : '-';
                const scoreBg = score !== '-' && parseInt(score) >= 3 ? '#dcfce7' : score !== '-' ? '#fef3c7' : '#f3f4f6';

                reportHtml += `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.dimensionName}</td>
                    <td>${q.pillarName}</td>
                    <td>${q.groupName}</td>
                    <td>${q.text}</td>
                    <td style="background: ${scoreBg}; text-align: center; font-weight: 500;">${score}</td>
                </tr>
`;
            });

            reportHtml += `
            </tbody>
        </table>

        <div class="timestamp">
            <strong>Report Type:</strong> Random Sample Analysis<br>
            <strong>Report Generated:</strong> ${new Date().toLocaleString()}<br>
            <strong>Sample Size:</strong> ${selectedQuestions.length} out of ${allQuestions.length} total questions<br>
            <strong>Filter Applied:</strong> ${scoreFilter}<br>
            <strong>Assessment Tool:</strong> DMI Assessment System v1.0<br>
            <strong>Organization:</strong> SAUDI COMPANY FOR VISA AND TRAVEL SOLUTIONS
        </div>
    </div>
</body>
</html>
`;

            const blob = new Blob([reportHtml], { type: "text/html" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `DMI_Random_Sample_Report_${new Date().getTime()}.html`;
            a.click();
            showToast(`Random sample report generated! (${selectedQuestions.length} questions)`);
        }

        function autoAnswerAndReport() {
            try {
                console.log('Auto-answer function called');

                const numQuestions = parseInt(document.getElementById('auto-answer-count').value);
                const distribution = document.getElementById('auto-answer-distribution').value;

                console.log('Settings:', numQuestions, distribution);

                // Confirm action
                if (!confirm(`This will randomly answer ${numQuestions} questions. Do you want to continue?`)) {
                    console.log('User cancelled');
                    return;
                }

                console.log('User confirmed, getting questions...');

                // Get all questions
                const allQuestions = getAllQuestions();
                console.log('Total questions available:', allQuestions.length);

                if (allQuestions.length === 0) {
                    alert('No questions found! Please ensure quiz data is loaded.');
                    return;
                }

                // Randomly select questions to answer
                const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffled.slice(0, numQuestions);

                console.log('Selected questions:', selectedQuestions.length);

                // Generate random answers based on distribution
                let answersGenerated = 0;
                selectedQuestions.forEach(q => {
                    let score;

                    switch (distribution) {
                        case 'low':
                            // Low range (0-2)
                            score = Math.floor(Math.random() * 3); // 0, 1, or 2
                            break;
                        case 'medium':
                            // Medium range (2-3)
                            score = Math.floor(Math.random() * 2) + 2; // 2 or 3
                            break;
                        case 'high':
                            // High range (3-5)
                            score = Math.floor(Math.random() * 3) + 3; // 3, 4, or 5
                            break;
                        case 'realistic':
                            // Realistic mix: weighted towards middle scores
                            const rand = Math.random();
                            if (rand < 0.1) score = 0;
                            else if (rand < 0.2) score = 1;
                            else if (rand < 0.4) score = 2;
                            else if (rand < 0.7) score = 3;
                            else if (rand < 0.9) score = 4;
                            else score = 5;
                            break;
                        default:
                            // Random (0-5)
                            score = Math.floor(Math.random() * 6);
                    }

                    userResponses[q.id] = score;
                    answersGenerated++;
                });

                console.log('Answers generated:', answersGenerated);

                // Save responses
                saveResponses();
                console.log('Responses saved to localStorage');

                // Generate comprehensive report
                const metrics = getDimensionMetrics();
                const totalQuestions = getTotalQuestionCount();
                const answeredCount = getAnsweredCount();
                const completionPercent = getCompletionPercentage();
                const totalScore = getTotalScore();
                const avgScore = answeredCount > 0 ? (totalScore / answeredCount).toFixed(2) : '0.00';

                console.log('Metrics calculated:', {
                    totalQuestions,
                    answeredCount,
                    completionPercent,
                    totalScore,
                    avgScore
                });

                // Calculate dimension-specific metrics
                const dimensionDetails = {};
                selectedQuestions.forEach(q => {
                    if (!dimensionDetails[q.dimensionName]) {
                        dimensionDetails[q.dimensionName] = {
                            name: q.dimensionName,
                            questions: [],
                            totalScore: 0,
                            avgScore: 0
                        };
                    }
                    dimensionDetails[q.dimensionName].questions.push({
                        ...q,
                        score: userResponses[q.id]
                    });
                    dimensionDetails[q.dimensionName].totalScore += userResponses[q.id];
                });

                // Calculate average scores per dimension
                Object.values(dimensionDetails).forEach(dim => {
                    dim.avgScore = (dim.totalScore / dim.questions.length).toFixed(2);
                });

                // Generate HTML report
                let reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DMI Auto-Generated Assessment Report</title>
    <style>
        * { margin: 0; padding: 0; }
        body { font-family: 'Cairo', 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .report { background: white; padding: 40px; max-width: 1200px; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #1e40af; margin-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        h3 { color: #3b82f6; margin-top: 20px; margin-bottom: 10px; }
        .summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .metric-card .label { font-size: 12px; opacity: 0.9; }
        .metric-card .value { font-size: 28px; font-weight: bold; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-complete { background: #dcfce7; color: #166534; }
        .status-partial { background: #fef3c7; color: #92400e; }
        .status-incomplete { background: #fee2e2; color: #991b1b; }
        .score-0 { background: #fee2e2; color: #991b1b; font-weight: bold; }
        .score-1 { background: #fed7aa; color: #9a3412; font-weight: bold; }
        .score-2 { background: #fef3c7; color: #92400e; font-weight: bold; }
        .score-3 { background: #dbeafe; color: #1e40af; font-weight: bold; }
        .score-4 { background: #d1fae5; color: #065f46; font-weight: bold; }
        .score-5 { background: #dcfce7; color: #166534; font-weight: bold; }
        .timestamp { font-size: 12px; color: #9ca3af; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
        .alert-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin-bottom: 20px; }
        .chart-section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="report">
        <h1>âš¡ DMI Auto-Generated Assessment Report</h1>
        <p style="color: #6b7280; margin-bottom: 20px;">Generated: ${new Date().toLocaleString()}</p>
        
        <div class="alert-box">
            <strong>ðŸ¤– Auto-Generated Report:</strong> ${numQuestions} questions were randomly answered using <strong>${distribution}</strong> distribution.
            <br><strong>Total Questions in System:</strong> ${totalQuestions} questions
            <br><strong>Coverage:</strong> ${Math.round((numQuestions / totalQuestions) * 100)}% of total questions
        </div>

        <h2>ðŸ“Š Executive Summary</h2>
        <div class="summary">
            <div class="metric-card">
                <div class="label">Total Questions</div>
                <div class="value">${totalQuestions}</div>
            </div>
            <div class="metric-card">
                <div class="label">Answered</div>
                <div class="value">${answeredCount}</div>
            </div>
            <div class="metric-card">
                <div class="label">Completion</div>
                <div class="value">${completionPercent}%</div>
            </div>
            <div class="metric-card">
                <div class="label">Total Score</div>
                <div class="value">${Math.round(totalScore)}</div>
            </div>
            <div class="metric-card">
                <div class="label">Avg Score</div>
                <div class="value">${avgScore}</div>
            </div>
        </div>

        <h2>ðŸ“ˆ Dimension-wise Performance</h2>
        <table>
            <thead>
                <tr>
                    <th>Dimension</th>
                    <th>Total Q</th>
                    <th>Answered</th>
                    <th>Completion</th>
                    <th>Total Score</th>
                    <th>Avg Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
`;

                metrics.forEach(dim => {
                    const completion = dim.totalQuestions > 0 ? Math.round((dim.answeredQuestions / dim.totalQuestions) * 100) : 0;
                    const statusClass = completion >= 75 ? 'status-complete' : completion >= 50 ? 'status-partial' : 'status-incomplete';
                    const statusText = completion >= 75 ? 'Excellent' : completion >= 50 ? 'Good' : 'Needs Attention';
                    const avgScoreFormatted = typeof dim.avgScore === 'number' ? dim.avgScore.toFixed(2) : dim.avgScore;

                    reportHtml += `
                <tr>
                    <td><strong>${dim.name}</strong></td>
                    <td>${dim.totalQuestions}</td>
                    <td>${dim.answeredQuestions}</td>
                    <td>${completion}%</td>
                    <td><strong>${Math.round(dim.totalScore)}</strong></td>
                    <td>${avgScoreFormatted}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>
`;
                });

                reportHtml += `
            </tbody>
        </table>

        <h2>ðŸ“‹ Detailed Question Analysis</h2>
        <p style="margin-bottom: 15px; color: #6b7280;">Showing ${numQuestions} randomly answered questions with their scores</p>
`;

                // Group by dimension
                Object.values(dimensionDetails).forEach(dim => {
                    reportHtml += `
        <h3>${dim.name} (${dim.questions.length} questions, Avg: ${dim.avgScore})</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Focus Area</th>
                    <th>Group</th>
                    <th>Question</th>
                    <th style="text-align: center;">Score</th>
                </tr>
            </thead>
            <tbody>
`;

                    dim.questions.forEach(q => {
                        const scoreClass = `score-${q.score}`;
                        reportHtml += `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.pillarName}</td>
                    <td>${q.groupName}</td>
                    <td>${q.text}</td>
                    <td class="${scoreClass}" style="text-align: center;">${q.score}</td>
                </tr>
`;
                    });

                    reportHtml += `
            </tbody>
        </table>
`;
                });

                reportHtml += `
        <div class="chart-section">
            <h3>ðŸ“Š Score Distribution</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Distribution of scores across all ${numQuestions} answered questions</p>
`;

                // Calculate score distribution
                const scoreDistribution = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                selectedQuestions.forEach(q => {
                    const score = userResponses[q.id];
                    scoreDistribution[score]++;
                });

                reportHtml += `
            <table style="max-width: 600px;">
                <thead>
                    <tr>
                        <th>Score Level</th>
                        <th>Count</th>
                        <th>Percentage</th>
                        <th>Visual</th>
                    </tr>
                </thead>
                <tbody>
`;

                for (let i = 0; i <= 5; i++) {
                    const count = scoreDistribution[i];
                    const percentage = Math.round((count / numQuestions) * 100);
                    const barWidth = percentage * 3; // Scale for visual bar
                    const scoreClass = `score-${i}`;

                    reportHtml += `
                    <tr>
                        <td class="${scoreClass}" style="text-align: center; width: 100px;">Level ${i}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td><div style="width: ${barWidth}px; height: 20px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 4px;"></div></td>
                    </tr>
`;
                }

                reportHtml += `
                </tbody>
            </table>
        </div>

        <div class="timestamp">
            <strong>Report Type:</strong> Auto-Generated Assessment with Random Answers<br>
            <strong>Generated:</strong> ${new Date().toLocaleString()}<br>
            <strong>Questions Answered:</strong> ${numQuestions} out of ${totalQuestions} total<br>
            <strong>Answer Distribution:</strong> ${distribution.charAt(0).toUpperCase() + distribution.slice(1)}<br>
            <strong>Overall Completion:</strong> ${completionPercent}%<br>
            <strong>Total Score:</strong> ${Math.round(totalScore)} points<br>
            <strong>Average Score:</strong> ${avgScore} / 5.0<br>
            <strong>Assessment Tool:</strong> DMI Assessment System v1.0<br>
            <strong>Organization:</strong> SAUDI COMPANY FOR VISA AND TRAVEL SOLUTIONS
        </div>
    </div>
</body>
</html>
`;

                console.log('Report HTML generated, creating download...');

                const blob = new Blob([reportHtml], { type: "text/html" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `DMI_Auto_Assessment_${numQuestions}Q_${new Date().getTime()}.html`;
                a.click();

                console.log('Report downloaded');

                // Export responses to JS file for dashboards to read
                const exportMetadata = {
                    questionsAnswered: answersGenerated,
                    distribution: distribution,
                    totalScore: Math.round(totalScore),
                    averageScore: avgScore,
                    completionPercent: completionPercent
                };
                exportResponsesToFile(userResponses, exportMetadata);

                showToast(`âœ… Auto-answered ${answersGenerated} questions and generated report! Navigating to Analytics...`);

                // Reload responses from localStorage to ensure data is fresh
                const savedResponses = localStorage.getItem('tasheer_resp_ent_v3');
                if (savedResponses) {
                    userResponses = JSON.parse(savedResponses);
                    console.log('Responses reloaded from localStorage:', Object.keys(userResponses).length, 'answers');
                }

                // Navigate to analytics dashboard to show results
                setTimeout(() => {
                    console.log('Navigating to analytics dashboard');
                    renderDashboardExec();
                }, 800);

            } catch (error) {
                console.error('Error in autoAnswerAndReport:', error);
                alert('An error occurred: ' + error.message);
            }
        }

        // Start
        function createConfigModal() {
            const html = `
            <div class="modal fade" id="configModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header"><h5 class="modal-title">Configuration</h5></div>
                        <div class="modal-body" id="config-body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="config-save-btn">Save Configuration</button>
                        </div>
                    </div>
                </div>
            </div>`;
            const tmp = document.createElement('div'); tmp.innerHTML = html; document.body.appendChild(tmp);
        }

        async function openConfig() {
            const modalEl = document.getElementById('configModal');
            const modal = new bootstrap.Modal(modalEl);
            await loadConfig();
            modal.show();
        }

        async function loadConfig() {
            let cfg = null;
            try {
                const resp = await fetch('/get-config');
                if (resp.ok) cfg = await resp.json();
            } catch (e) { }
            if (!cfg) {
                const s = localStorage.getItem('tasheer_config');
                if (s) cfg = JSON.parse(s);
            }
            if (!cfg) cfg = appData;
            renderConfigForm(cfg);
        }

        function renderConfigForm(cfg) {
            const body = document.getElementById('config-body');
            body.innerHTML = '';
            cfg.forEach((dim, dIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-3 p-3 border rounded';
                wrapper.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <input class="form-control me-2 cfg-dname" data-didx="${dIdx}" value="${escapeHtml(dim.name)}" placeholder="Dimension name">
                        <input class="form-control me-2 cfg-dpoints" data-didx-points="${dIdx}" value="${dim.points || 0}" style="width:110px">
                    </div>
                    <div class="pillars-container" data-didx="${dIdx}">
                        ${dim.pillars.map((p, pIdx) => `
                            <div class="mb-2 d-flex align-items-center">
                                <input class="form-control me-2 cfg-pname" data-didx="${dIdx}" data-pidx="${pIdx}" value="${escapeHtml(p.name)}">
                            </div>
                        `).join('')}
                    </div>
                `;
                body.appendChild(wrapper);
            });
            const saveBtn = document.getElementById('config-save-btn');
            saveBtn.onclick = saveConfig;
        }

        function collectConfigFromForm() {
            const body = document.getElementById('config-body');
            const dims = [];
            body.querySelectorAll('.cfg-dname').forEach(input => {
                const dIdx = input.getAttribute('data-didx');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].name = input.value;
            });
            body.querySelectorAll('.cfg-dpoints').forEach(input => {
                const dIdx = input.getAttribute('data-didx-points');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].points = parseInt(input.value) || 0;
            });
            body.querySelectorAll('.cfg-pname').forEach(input => {
                const dIdx = input.getAttribute('data-didx');
                const pIdx = input.getAttribute('data-pidx');
                dims[dIdx] = dims[dIdx] || { name: '', points: 0, pillars: [] };
                dims[dIdx].pillars[pIdx] = { name: input.value, groups: JSON.parse(JSON.stringify(standardGroups)) };
            });
            return dims.map(d => ({ id: d.name.toLowerCase().replace(/\s+/g, '_'), name: d.name, points: d.points, pillars: d.pillars.map(p => p || { name: 'Unnamed', groups: JSON.parse(JSON.stringify(standardGroups)) }) }));
        }

        async function saveConfig() {
            const cfg = collectConfigFromForm();
            try {
                const resp = await fetch('/save-config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg) });
                if (resp.ok) {
                    showToast('Saved to server');
                    appData = cfg; seedStructureOnly(); saveData(); renderSidebar();
                    const modalEl = document.getElementById('configModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    return;
                }
            } catch (e) { }
            localStorage.setItem('tasheer_config', JSON.stringify(cfg));
            appData = cfg; seedStructureOnly(); saveData(); renderSidebar();
            showToast('Saved locally (no server)');
            const modalEl = document.getElementById('configModal');
            bootstrap.Modal.getInstance(modalEl).hide();
        }

        function escapeHtml(str) { if (!str) return ''; return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('\"', '&quot;').replaceAll("'", "&#39;"); }

        // --- RANDOM SELECTION DATA STORAGE ---
        let currentRandomSelection = null;

        // Generate random score based on distribution
        function generateScoreByDistribution(distribution) {
            switch (distribution) {
                case 'low':
                    return Math.floor(Math.random() * 3); // 0, 1, or 2
                case 'medium':
                    return Math.floor(Math.random() * 2) + 2; // 2 or 3
                case 'high':
                    return Math.floor(Math.random() * 3) + 3; // 3, 4, or 5
                case 'realistic':
                    const rand = Math.random();
                    if (rand < 0.1) return 0;
                    else if (rand < 0.2) return 1;
                    else if (rand < 0.4) return 2;
                    else if (rand < 0.7) return 3;
                    else if (rand < 0.9) return 4;
                    else return 5;
                default: // random
                    return Math.floor(Math.random() * 6);
            }
        }

        // Generate random selection of questions with scores
        function generateRandomSelection() {
            try {
                const sampleSize = parseInt(document.getElementById('data-sample-size').value);
                const distribution = document.getElementById('data-distribution').value;

                console.log('Generating random selection:', sampleSize, 'questions with', distribution, 'distribution');

                // Directly read from the 5 quiz files to ensure we get all questions
                const quizFiles = [
                    quiz_1_external_applications,
                    quiz_2_internal_applications,
                    quiz_3_security_compliance,
                    quiz_4_monitoring_controls,
                    quiz_5_innovation_edge
                ];

                // Extract all questions from quiz files
                const allQuestions = [];
                quizFiles.forEach(quiz => {
                    quiz.pillars.forEach(pillar => {
                        pillar.groups.forEach(group => {
                            group.questions.forEach(q => {
                                allQuestions.push({
                                    ...q,
                                    dimension: quiz.name,
                                    dimensionId: quiz.id,
                                    pillar: pillar.name,
                                    pillarId: pillar.id,
                                    group: group.name,
                                    groupId: group.id
                                });
                            });
                        });
                    });
                });

                console.log('Total questions from quiz files:', allQuestions.length);

                if (allQuestions.length === 0) {
                    showToast('No questions found! Please ensure quiz data is loaded.');
                    return;
                }

                // Randomly select questions
                const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffled.slice(0, Math.min(sampleSize, allQuestions.length));

                // Generate responses for selected questions
                const responses = {};
                let totalScore = 0;

                selectedQuestions.forEach(q => {
                    const score = generateScoreByDistribution(distribution);
                    responses[q.id] = score;
                    totalScore += score;
                });

                // Calculate metrics
                const avgScore = (totalScore / selectedQuestions.length).toFixed(2);

                // Build dimension breakdown
                const dimensionBreakdown = {};
                selectedQuestions.forEach(q => {
                    if (!dimensionBreakdown[q.dimension]) {
                        dimensionBreakdown[q.dimension] = {
                            name: q.dimension,
                            questions: 0,
                            totalScore: 0,
                            avgScore: 0
                        };
                    }
                    dimensionBreakdown[q.dimension].questions++;
                    dimensionBreakdown[q.dimension].totalScore += responses[q.id];
                });

                // Calculate average per dimension
                Object.values(dimensionBreakdown).forEach(dim => {
                    dim.avgScore = (dim.totalScore / dim.questions).toFixed(2);
                });

                // Store current selection
                currentRandomSelection = {
                    metadata: {
                        generated: new Date().toISOString(),
                        generatedReadable: new Date().toLocaleString(),
                        questionsSelected: selectedQuestions.length,
                        totalQuestionsAvailable: allQuestions.length,
                        distribution: distribution,
                        totalScore: totalScore,
                        averageScore: parseFloat(avgScore),
                        completionPercent: Math.round((selectedQuestions.length / allQuestions.length) * 100)
                    },
                    dimensionBreakdown: dimensionBreakdown,
                    questions: selectedQuestions.map(q => ({
                        id: q.id,
                        text: q.text,
                        dimension: q.dimension,
                        pillar: q.pillar,
                        group: q.group,
                        score: responses[q.id]
                    })),
                    responses: responses
                };

                // Merge responses with userResponses for immediate dashboard update
                Object.assign(userResponses, responses);
                saveResponses();

                // Update UI summary
                document.getElementById('selection-summary').classList.remove('d-none');
                document.getElementById('sum-questions').innerText = selectedQuestions.length;
                document.getElementById('sum-score').innerText = totalScore;
                document.getElementById('sum-avg').innerText = avgScore;
                document.getElementById('sum-status').innerText = 'Generated';
                document.getElementById('sum-status').className = 'badge bg-warning';

                // Enable save button
                document.getElementById('btn-save-data').disabled = false;

                // Refresh dashboard
                renderDashboardExec();

                showToast(`âœ… Generated ${selectedQuestions.length} questions from ${allQuestions.length} total. Click 'Save QuizResult.js' to export.`);

            } catch (error) {
                console.error('Error in generateRandomSelection:', error);
                showToast('Error generating selection: ' + error.message);
            }
        }

        // File handle for direct saving
        let quizResultFileHandle = null;

        // Save current selection to QuizResult.js file directly
        async function saveQuizResult() {
            if (!currentRandomSelection) {
                showToast('Please generate a random selection first.');
                return;
            }

            try {
                const fileContent = `// DMI Assessment Quiz Results - Auto-generated
// This file contains the randomly selected questions with their scores
// Generated: ${currentRandomSelection.metadata.generatedReadable}
// File: assets/quizzes/QuizResult.js

const quizResult = {
    metadata: {
        generated: "${currentRandomSelection.metadata.generated}",
        generatedReadable: "${currentRandomSelection.metadata.generatedReadable}",
        questionsSelected: ${currentRandomSelection.metadata.questionsSelected},
        totalQuestionsAvailable: ${currentRandomSelection.metadata.totalQuestionsAvailable},
        distribution: "${currentRandomSelection.metadata.distribution}",
        totalScore: ${currentRandomSelection.metadata.totalScore},
        averageScore: ${currentRandomSelection.metadata.averageScore},
        completionPercent: ${currentRandomSelection.metadata.completionPercent}
    },
    dimensionBreakdown: ${JSON.stringify(currentRandomSelection.dimensionBreakdown, null, 8)},
    questions: ${JSON.stringify(currentRandomSelection.questions, null, 8)},
    responses: ${JSON.stringify(currentRandomSelection.responses, null, 8)}
};

// Export for use in the application
if (typeof module !== 'undefined' && module.exports) {
    module.exports = quizResult;
}
`;

                // Check if File System Access API is available
                if ('showSaveFilePicker' in window) {
                    // Use File System Access API for direct file saving
                    if (!quizResultFileHandle) {
                        // First time: ask user to select the file location
                        quizResultFileHandle = await window.showSaveFilePicker({
                            suggestedName: 'QuizResult.js',
                            types: [{
                                description: 'JavaScript Files',
                                accept: { 'text/javascript': ['.js'] }
                            }]
                        });
                    }

                    // Write to the file directly
                    const writable = await quizResultFileHandle.createWritable();
                    await writable.write(fileContent);
                    await writable.close();

                    // Update status
                    document.getElementById('sum-status').innerText = 'Saved âœ“';
                    document.getElementById('sum-status').className = 'badge bg-success';

                    showToast('âœ… QuizResult.js saved directly! Refresh page to see updates on dashboard.');
                } else {
                    // Fallback: download the file
                    const blob = new Blob([fileContent], { type: 'text/javascript' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'QuizResult.js';
                    a.click();

                    // Update status
                    document.getElementById('sum-status').innerText = 'Downloaded';
                    document.getElementById('sum-status').className = 'badge bg-warning';

                    showToast('âš ï¸ Your browser doesn\'t support direct file saving. File downloaded - please move it to assets/quizzes/');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('Save cancelled.');
                    return;
                }
                console.error('Error saving QuizResult.js:', error);
                showToast('Error saving file: ' + error.message);
            }
        }

        // Load data from QuizResult.js if available
        function loadQuizResultData() {
            if (typeof quizResult !== 'undefined' && quizResult.responses) {
                console.log('Loading data from QuizResult.js...');
                console.log('Questions loaded:', Object.keys(quizResult.responses).length);

                // Merge responses into userResponses
                Object.assign(userResponses, quizResult.responses);
                saveResponses();

                // Store as current selection
                currentRandomSelection = quizResult;

                // Update UI if elements exist
                const summaryEl = document.getElementById('selection-summary');
                if (summaryEl) {
                    summaryEl.classList.remove('d-none');
                    document.getElementById('sum-questions').innerText = quizResult.metadata.questionsSelected || 0;
                    document.getElementById('sum-score').innerText = quizResult.metadata.totalScore || 0;
                    document.getElementById('sum-avg').innerText = quizResult.metadata.averageScore || '0.00';
                    document.getElementById('sum-status').innerText = 'Loaded from QuizResult.js';
                    document.getElementById('sum-status').className = 'badge bg-info';
                }

                console.log('QuizResult.js loaded successfully!');
                return true;
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', function () {
            initApp();
            createConfigModal();

            // Try to load from QuizResult.js after a short delay (to ensure DOM is ready)
            setTimeout(() => {
                if (loadQuizResultData()) {
                    renderDashboardExec();
                    console.log('Dashboard updated from QuizResult.js');
                }
            }, 500);
        });

    </script>
</body>

</html>